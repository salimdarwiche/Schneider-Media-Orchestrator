<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Schneider Electric Media Orchestrator — V6</title>

<!-- pdf.js core -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
  :root{
    /* Schneider Electric Brand Palette */
    --se-life-green: #3DCD58;   /* Primary */
    --se-logo-green: #009530;   /* Logo only (not used in UI styles) */
    --se-dark-gray:  #626469;   /* Support */
    --se-light-gray: #9FA0A4;   /* Support */
    --se-white:      #FFFFFF;
    --se-black:      #000000;

    /* Derived neutrals */
    --border: rgba(159,160,164,0.65);
    --surface: #FFFFFF;
    --surface-alt: #F7F7F7;
    --text: #1f2937;
    --text-muted: #626469;
    --focus: #3DCD58;

    --agenda-accent: var(--se-life-green);
    --agenda-progress-bg: #e5e7eb;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  html,body { height:100%; width:100vw; background:var(--se-black); font-family:Inter,system-ui,Arial,sans-serif; color:var(--text); overflow:hidden; }
  html.menu-visible,body.menu-visible { background:var(--se-life-green); }
  
  /* Ensure no unwanted overlays on media */
  .empty-state { background:transparent; }
  
  ::-webkit-scrollbar { width:8px; height:8px; }
  ::-webkit-scrollbar-thumb { background: var(--se-light-gray); border-radius:10px }
  ::-webkit-scrollbar-thumb:hover { background: var(--se-dark-gray) }

  .skip-link{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
  .skip-link:focus{
    left:12px; top:12px; width:auto; height:auto; padding:8px 12px;
    background:var(--se-white); color:var(--se-dark-gray);
    border:2px solid var(--se-life-green); border-radius:8px; z-index:2000;
    outline:none;
  }

  /* Menu */
  /* FEATURE 6: Menu toggle */
  .menu-panel { position:fixed; background:var(--surface); box-shadow:0 10px 15px rgba(0,0,0,.06); z-index:100; display:flex; flex-direction:column; overflow:hidden; --menu-font-scale:1; transition:opacity 0.3s ease; }
  .menu-panel.left  { top:0; left:0; width:340px; height:100vh; border-right:1px solid var(--border); }
  .menu-panel.right { top:0; right:0; width:340px; height:100vh; border-left:1px solid var(--border); }
  .menu-panel.top   { top:0; left:0; width:100vw; height:100px; flex-direction:row; border-bottom:1px solid var(--border); }
  .menu-panel.bottom{ bottom:0; left:0; width:100vw; height:100px; flex-direction:row; border-top:1px solid var(--border); }
  .menu-panel.hidden { display:none !important; }

  /* FEATURE 6: Menu toggle button */
  .menu-toggle-btn {
    position:fixed; z-index:150;
    background:var(--se-life-green); color:var(--se-white);
    border:2px solid var(--se-white); border-radius:9999px;
    width:48px; height:48px; display:flex; align-items:center; justify-content:center;
    cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.25);
    transition:all .15s;
  }
  .menu-toggle-btn:hover { transform:scale(1.05); box-shadow:0 6px 16px rgba(0,0,0,0.3); }
  .menu-toggle-btn svg { width:24px; height:24px; }
  .menu-toggle-btn.left { top:20px; left:360px; }
  .menu-toggle-btn.right { top:20px; right:360px; }
  .menu-toggle-btn.top { top:120px; left:20px; }
  .menu-toggle-btn.bottom { bottom:120px; left:20px; }

  /* Back navigation button - opposite side of menu toggle */
  .nav-back-btn {
    position:fixed; top:20px; right:20px; z-index:150;
    background:var(--se-life-green); color:var(--se-white);
    border:2px solid var(--se-white); border-radius:9999px;
    width:48px; height:48px; display:flex; align-items:center; justify-content:center;
    cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.25);
    transition:all .15s; opacity:0; pointer-events:none;
  }
  .nav-back-btn.show { opacity:1; pointer-events:auto; }
  .nav-back-btn:hover { transform:scale(1.05); box-shadow:0 6px 16px rgba(0,0,0,0.3); }
  .nav-back-btn svg { width:24px; height:24px; }
  
  /* Floating fullscreen button (near back button) */
  .floating-fullscreen-btn {
    position:fixed; top:20px; right:80px; z-index:150;
    background:var(--se-life-green); color:var(--se-white);
    border:2px solid var(--se-white); border-radius:9999px;
    width:48px; height:48px; display:flex; align-items:center; justify-content:center;
    cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.25);
    transition:all .15s;
  }
  .floating-fullscreen-btn:hover { transform:scale(1.05); box-shadow:0 6px 16px rgba(0,0,0,0.3); }
  .floating-fullscreen-btn svg { width:24px; height:24px; }
  
  .menu-toggle-btn.hidden-position.left { left:20px; }
  .menu-toggle-btn.hidden-position.right { right:20px; }
  .menu-toggle-btn.hidden-position.top { top:20px; }
  .menu-toggle-btn.hidden-position.bottom { bottom:20px; }

  .logo-header { height:72px; background:var(--se-life-green); display:flex; align-items:center; justify-content:center; padding:0 20px; flex-shrink:0; }
  .menu-panel.top .logo-header, .menu-panel.bottom .logo-header { display:none; }
  .logo-header img { height:auto; max-width:280px; width:100%; object-fit:contain; }

  .resize-handle { position:absolute; z-index:120; background:var(--se-light-gray); opacity:.18; transition:opacity .15s, background .15s; }
  .resize-handle:hover, .resize-handle.active { opacity:.72; background:var(--se-life-green); }
  .menu-panel.left .resize-handle  { right:0; top:0; bottom:0; width:8px; cursor:ew-resize; }
  .menu-panel.right .resize-handle { left:0; top:0; bottom:0; width:8px; cursor:ew-resize; }
  .menu-panel.top .resize-handle   { left:0; right:0; bottom:0; height:8px; cursor:ns-resize; }
  .menu-panel.bottom .resize-handle{ left:0; right:0; top:0; height:8px; cursor:ns-resize; }

  .menu-content { flex:1; overflow:auto; padding:20px; display:flex; flex-direction:column; gap:18px; }
  
  /* Scrollbar opposite to resize handle for easier scrolling */
  .menu-panel.left .menu-content { direction: rtl; }
  .menu-panel.left .menu-content > * { direction: ltr; }

  /* Sections and headers larger and spaced */
  .menu-section { display:flex; flex-direction:column; gap:10px; }
  .menu-section + .menu-section { margin-top:16px; padding-top:16px; border-top:2px solid var(--surface-alt); }

  .menu-label {
    font-size: clamp(14px, calc(16px * var(--menu-font-scale, 1)), 20px);
    font-weight:800; color:var(--text-muted); letter-spacing:0.5px; text-transform:uppercase;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
  }

  .label-actions { display:flex; gap:10px; align-items:center; }

  .file-list { display:flex; flex-direction:column; gap:10px; }
  /* NEW: Hide scrolling lists in top/bottom, show only dropdowns */
  .menu-panel.top .file-list, .menu-panel.bottom .file-list { display:none; }

  .compact-row { display:none; gap:10px; align-items:center; justify-content:center; width:100%; }
  .menu-panel.top .compact-row, .menu-panel.bottom .compact-row { display:flex; padding:6px 10px; }
  /* NEW: Hide individual compact rows in top/bottom, show combined only */
  .menu-panel.top #videoCompactRow, .menu-panel.bottom #videoCompactRow,
  .menu-panel.top #presentationCompactRow, .menu-panel.bottom #presentationCompactRow { display:none!important; }
  .menu-panel.top .combined-media-row, .menu-panel.bottom .combined-media-row { display:flex!important; }
  .compact-row label { font-size: clamp(13px, calc(14px * var(--menu-font-scale,1)), 16px); }
  select.compact-select { padding:8px 10px; border-radius:8px; border:1.5px solid var(--border); min-width:220px; font-weight:600; color:var(--text-muted); background:var(--se-white); font-size: clamp(13px, calc(14px * var(--menu-font-scale,1)), 16px); }

  .file-item { background:var(--surface); border:2px solid var(--border); border-radius:10px; padding:12px 14px;
    font-size: clamp(14px, calc(15px * var(--menu-font-scale,1)), 18px); font-weight:600; color:var(--text); cursor:pointer;
    display:flex; align-items:center; gap:8px; overflow:hidden; transition:all .12s; position:relative;
  }
  .menu-panel.top .file-item, .menu-panel.bottom .file-item { min-width:220px; flex:0 0 auto; padding:18px; text-align:center; white-space:normal; font-size: clamp(15px, calc(16px * var(--menu-font-scale,1)), 20px); }
  .file-item:hover { background:var(--surface-alt); border-color:var(--se-life-green); transform:translateY(-1px); }
  .file-item.selected { background:linear-gradient(135deg,var(--se-life-green) 0%,#2ea649 100%); color:var(--se-white); border-color:var(--se-life-green); box-shadow:0 4px 6px rgba(61,205,88,0.18); }
  .file-item.dragging { opacity:.4; cursor:grabbing!important; }
  /* NEW: Multi-select checkbox in meeting mode */
  .file-item .multi-select-checkbox { position:absolute; top:8px; right:8px; width:20px; height:20px; }
  .file-item.multi-selected { border-color:var(--se-life-green); background:rgba(61,205,88,0.1); }

  /* NEW: Dropdown styles for top/bottom menu */
  .compact-dropdown { width:100%; max-width:300px; padding:10px 12px; border:1.5px solid var(--border); border-radius:10px; background:var(--se-white); font-weight:600; color:var(--text); cursor:pointer; font-size:14px; }
  .compact-dropdown:focus { outline:2px solid var(--focus); outline-offset:2px; }

  /* NEW: Multi-select toolbar (inside menu) */
  .multi-select-toolbar { 
    position:sticky; top:0; z-index:200;
    padding:12px; background:var(--surface-alt); border-radius:10px; margin-top:12px; 
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .multi-select-toolbar .compact-dropdown { max-width:100%; }
  
  /* NEW: Floating assign toolbar (outside menu, always visible) */
  .floating-assign-toolbar {
    position:fixed; z-index:500;
    padding:16px 20px; background:rgba(255,255,255,0.98);
    border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.2);
    backdrop-filter:blur(10px); border:2px solid var(--se-life-green);
    transition:all 0.2s ease; opacity:0; pointer-events:none;
  }
  .floating-assign-toolbar.show {
    opacity:1; pointer-events:auto;
  }
  .floating-assign-toolbar .compact-dropdown {
    padding:8px 12px; border-radius:8px; font-size:14px;
  }
  .floating-assign-toolbar .icon-btn {
    padding:8px; border-radius:8px;
  }

  .file-item-name { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .menu-panel.top .file-item .file-item-name, .menu-panel.bottom .file-item .file-item-name { white-space:normal; overflow:visible; }

  /* FEATURE 1: Video duration display */
  .file-item-duration { font-size:12px; color:var(--text-muted); font-weight:700; margin-left:auto; padding-left:8px; }
  .file-item.selected .file-item-duration { color:rgba(255,255,255,0.9); }

  /* FEATURE 2: Search bars */
  .search-container { display:flex; gap:8px; margin-bottom:10px; }
  .search-input {
    flex:1; padding:8px 12px; border:1.5px solid var(--border);
    border-radius:8px; font-size:14px; font-weight:600;
    color:var(--text); background:var(--se-white);
  }
  .search-input:focus { outline:2px solid var(--focus); outline-offset:2px; border-color:var(--focus); }
  .file-item.hidden { display:none; }
  /* NEW: Hide search in top/bottom layouts (using dropdowns) */
  .menu-panel.top .search-container, .menu-panel.bottom .search-container { display:none; }

  .helper-text { font-size:calc(11px * var(--menu-font-scale,1)); color:var(--text-muted); margin-top:8px; font-weight:500; }
  .menu-footer { border-top:1px solid var(--border); padding:12px 16px; background:var(--surface-alt); display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }

  /* Icon-only buttons: responsive */
  .icon-btn {
    width: clamp(32px, calc(36px * var(--menu-font-scale,1)), 44px);
    height: clamp(32px, calc(36px * var(--menu-font-scale,1)), 44px);
    border-radius:9999px;
    border:1.5px solid var(--border);
    background:var(--se-white); cursor:pointer;
    display:inline-flex; align-items:center; justify-content:center;
    transition:border-color .15s, background .15s, box-shadow .15s, color .15s;
    color:var(--text-muted);
    flex: 0 0 auto;
  }
  .icon-btn:hover { border-color:var(--se-life-green); background:var(--surface-alt); }
  .icon-btn:focus { outline:2px solid var(--focus); outline-offset:2px; }
  .icon-btn.active { color: var(--se-life-green); border-color: var(--se-life-green); background: var(--surface); }
  .icon-btn svg { width: clamp(16px, calc(18px * var(--menu-font-scale,1)), 22px); height: clamp(16px, calc(18px * var(--menu-font-scale,1)), 22px); display:block; }
  .icon-btn svg use { fill: currentColor; }
  .icon-btn[disabled] { opacity:.5; cursor:not-allowed; }

  /* main content */
  /* FEATURE 6: Adjust main content when menu hidden */
  .main-content { position:fixed; background:var(--se-black); display:flex; align-items:center; justify-content:center; overflow:hidden; transition:all 0.3s ease; }
  .main-content.left { top:0; left:340px; width:calc(100vw - 340px); height:100vh; }
  .main-content.right { top:0; right:340px; width:calc(100vw - 340px); height:100vh; }
  .main-content.top { top:100px; left:0; width:100vw; height:calc(100vh - 100px); }
  .main-content.bottom { top:0; left:0; width:100vw; height:calc(100vh - 100px); }
  /* NEW: Full viewport when menu is hidden */
  .main-content.menu-hidden { position:fixed; top:0; left:0; width:100vw; height:100vh; }

  .video-container { position:relative; width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:var(--se-black); }
  .video-container video { width:100%; height:100%; object-fit:contain; background:var(--se-black); }

  /* Video topbar */
  /* NEW: Position Back button away from menu toggle */
  .video-topbar {
    position:absolute; top:12px; left:12px; right:auto;
    display:flex; gap:8px; align-items:center;
    background:rgba(0,0,0,0.35);
    padding:6px; border-radius:9999px;
  }
  .video-topbar .icon-btn { width:40px; height:40px; }
  .video-topbar .icon-btn svg { width:20px; height:20px; }
  /* NEW: Move topbar when menu toggle button is visible */
  .main-content.left .video-topbar { left:80px; }
  .main-content.menu-hidden.left .video-topbar { left:80px; }

  .presentation-container { display:none; width:100%; height:100%; flex-direction:column; background:var(--se-black); color:var(--se-white); position:relative; }
  
  /* Modern compact presentation controls - PowerPoint-style, bottom-right (opposite of menu) */
  .presentation-controls {
    position:absolute; bottom:12px; right:12px;
    display:flex; gap:6px; padding:6px 10px; align-items:center;
    background:rgba(0,0,0,0.8); backdrop-filter:blur(8px);
    border-radius:20px; border:1px solid rgba(255,255,255,0.2);
    box-shadow:0 2px 8px rgba(0,0,0,0.4);
    z-index:100; transition:opacity .2s;
  }
  .presentation-controls button {
    padding:4px 10px; background:transparent; border:1px solid rgba(255,255,255,0.25);
    color:var(--se-white); border-radius:12px; cursor:pointer; font-weight:600;
    font-size:12px; transition:all .15s; display:flex; align-items:center; gap:3px;
    min-width:55px; justify-content:center;
  }
  .presentation-controls button:hover:not(:disabled) {
    background:var(--se-life-green); border-color:var(--se-life-green);
    transform:scale(1.05);
  }
  .presentation-controls button:disabled {
    opacity:0.3; cursor:not-allowed;
  }
  .presentation-controls .page-info {
    color:var(--se-white); font-weight:600; font-size:11px;
    padding:0 6px; white-space:nowrap; opacity:0.85;
  }
  
  /* PDF canvas wrapper and sizing - maintain aspect ratio through JS rendering */
  .pdf-canvas-wrapper { flex:1; display:flex; align-items:center; justify-content:center; background:var(--se-black); width:100%; overflow:hidden; position:relative; cursor:pointer; }
  #pdfCanvas { background:var(--se-white); display:block; cursor:pointer; }

  /* Modals */
  .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:1000; }
  .modal-overlay.show { display:flex; }
  .modal-dialog { width:min(1020px,92vw); max-height:90vh; background:var(--se-white); border-radius:16px; overflow:hidden; display:flex; flex-direction:column; box-shadow:0 30px 60px rgba(0,0,0,0.3); }
  .modal-header { position:relative; padding:16px 20px; background:var(--se-white); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:16px; }
  .modal-header::before{ content:""; position:absolute; left:0; right:0; top:0; height:4px; background:var(--se-life-green); }
  .modal-title { display:flex; align-items:center; gap:10px; font-weight:800; color:var(--se-life-green); flex-shrink:0; }
  .modal-title svg { width:20px; height:20px; color:var(--se-life-green); }
  .modal-close { background:transparent; border:none; font-size:28px; line-height:1; cursor:pointer; color:var(--se-dark-gray); font-weight:800; margin-left:auto; }
  .modal-close:focus { outline:2px solid var(--focus); outline-offset:2px; }
  .modal-close:hover { color:var(--se-black); }
  .modal-body { padding:20px; overflow:auto; display:grid; grid-template-columns:1fr 1fr; gap:20px; }
  /* NEW: Better Settings organization */
  .modal-body.tabbed { display:block; padding:20px; }
  .settings-tabs { display:flex; gap:10px; flex:1; justify-content:center; }
  .settings-tab { padding:10px 20px; border:none; background:var(--surface-alt); color:var(--text-muted); font-weight:700; cursor:pointer; border-radius:8px 8px 0 0; transition:all .2s; font-size:15px; }
  .settings-tab.active { background:var(--se-life-green); color:var(--se-white); }
  .settings-tab:hover:not(.active) { background:rgba(61,205,88,0.1); }
  .tab-content { display:none; padding:0; margin-top:20px; }
  .tab-content.active { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
  /* NEW: Media Library symmetric layout */
  #mediaTab.active { display:flex; flex-direction:column; gap:20px; align-items:center; }
  #mediaTab .modal-section { width:100%; max-width:800px; }
  #mediaTab .mini-list { min-height:250px; max-height:350px; }
  
  .modal-section { border:1.5px solid var(--border); border-radius:12px; padding:14px; background:var(--se-white); box-shadow:0 8px 18px rgba(0,0,0,0.04); }
  .section-title { display:flex; align-items:center; gap:10px; font-weight:800; color:var(--se-dark-gray); margin-bottom:10px; }
  .section-title svg { width:18px; height:18px; color:var(--se-life-green); }

  .file-picker { padding:10px 14px; background:var(--se-life-green); color:var(--se-white); border:none; border-radius:10px; cursor:pointer; font-weight:800; display:inline-flex; align-items:center; gap:8px; }
  .file-picker:focus { outline:2px solid var(--focus); outline-offset:2px; }
  .file-picker svg { width:16px; height:16px; color:currentColor; }
  /* NEW: Clear button style */
  .file-picker.danger { background:#dc2626; }
  .file-picker.danger:hover { background:#b91c1c; }
  
  /* NEW: Build Agenda button */
  .build-agenda-btn { padding:12px 18px; background:var(--se-life-green); color:var(--se-white); border:none; border-radius:10px; cursor:pointer; font-weight:800; display:inline-flex; align-items:center; gap:10px; font-size:15px; box-shadow:0 4px 6px rgba(61,205,88,0.25); transition:all .15s; }
  .build-agenda-btn:hover { transform:translateY(-1px); box-shadow:0 6px 10px rgba(61,205,88,0.35); }
  .build-agenda-btn svg, .build-agenda-btn img { width:24px; height:24px; }

  .inline-control { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .sort-select { padding:8px 12px; border:1.5px solid var(--border); border-radius:10px; background:var(--se-white); font-size:13px; font-weight:700; cursor:pointer; color:var(--se-dark-gray); }
  .sort-select:focus { outline:2px solid var(--focus); outline-offset:2px; }

  .mini-list { display:flex; flex-direction:column; gap:8px; max-height:240px; overflow:auto; margin-top:12px; }
  .mini-item { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1.5px solid var(--border); border-radius:10px; background:var(--se-white); cursor:grab; }
  .mini-item.dragging { opacity:.5; cursor:grabbing; }
  .mini-item .item-name { flex:1; padding:2px 6px; outline:none; border-radius:6px; color:var(--text); }
  .mini-item .item-name:focus { outline:2px solid var(--focus); }
  .mini-remove { padding:6px 8px; cursor:pointer; color:var(--se-dark-gray); border-radius:8px; font-weight:800; }
  .mini-remove:hover { background:var(--surface-alt); color:var(--se-dark-gray); }

  /* Meeting Mode: Agenda in Settings */
  .agenda-builder { display:flex; flex-direction:column; gap:10px; }
  /* FEATURE 4 & 5: Duration input and Subtitle support */
  .agenda-row { display:grid; grid-template-columns:40px 1fr 140px 140px 100px 40px; gap:8px; align-items:center; }
  .agenda-row input[type="text"], .agenda-row input[type="time"], .agenda-row input[type="number"] {
    padding:8px 10px; border:1.5px solid var(--border); border-radius:8px; font-weight:600; color:var(--text);
  }
  .agenda-row .subtitle-input {
    grid-column: 2 / 3;
    font-size:13px;
    font-style:italic;
    margin-top:4px;
  }
  .agenda-row .del-slot { text-align:center; cursor:pointer; color:var(--text-muted); border:1.5px solid var(--border); border-radius:8px; padding:6px 0; }
  .agenda-row .del-slot:hover { background:var(--surface-alt); }
  .add-slot-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .add-quick { padding:8px 12px; border:1.5px solid var(--border); background:var(--se-white); border-radius:8px; cursor:pointer; font-weight:800; color:var(--text-muted); }
  .add-quick:hover { background:var(--surface-alt); }
  .grip { user-select:none; cursor:grab; text-align:center; color:var(--text-muted); font-weight:800; }

  /* Meeting Mode: Agenda in Menu */
  .agenda-panel { display:flex; flex-direction:column; gap:10px; position:relative; }
  
  /* Overall progress bar (vertical, left side) */
  .agenda-overall-progress { position:absolute; left:-20px; top:0; bottom:0; width:8px; background:var(--agenda-progress-bg); border-radius:9999px; overflow:hidden; }
  .agenda-overall-progress .progress-fill { position:absolute; top:0; left:0; right:0; background:var(--agenda-accent); transition:height .3s; height:0%; }
  .agenda-overall-progress .progress-indicator { position:absolute; left:50%; transform:translateX(-50%); width:16px; height:16px; background:var(--agenda-accent); border:3px solid var(--se-white); border-radius:50%; transition:top .3s; top:0%; margin-top:-8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
  
  /* Locked agenda state */
  .agenda-panel.locked .quick-actions-container,
  .agenda-panel.locked .slot-checkbox,
  .agenda-panel.locked .si-x { display:none !important; }
  .agenda-panel.locked .slot-items { border-style:solid; border-color:var(--border); }
  .agenda-panel.locked .agenda-slot { padding-left:8px; }
  .gmt-clock { display:flex; align-items:center; justify-content:space-between; background:var(--surface-alt); border:1.5px solid var(--border); border-radius:10px; padding:10px 12px; font-weight:800; color:var(--text-muted); }
  .agenda-slot {
    border:2px solid var(--border);
    border-radius:10px;
    padding:10px;
    background:var(--surface);
    transition:all 0.3s ease;
  }
  .agenda-slot.active { border-color: var(--agenda-accent); box-shadow:0 4px 8px rgba(61,205,88,0.12); }
  .agenda-slot.completed {
    background:rgba(61,205,88,0.08);
    opacity:0.7;
  }
  .agenda-slot.completed .slot-title,
  .agenda-slot.completed .slot-time,
  .agenda-slot.completed .slot-subtitle {
    opacity:0.6;
  }
  .slot-checkbox {
    width:18px; height:18px; cursor:pointer;
    accent-color:var(--se-life-green);
    flex-shrink:0;
  }
  .slot-header { display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
  .slot-title { font-weight:800; color:var(--text); }
  /* FEATURE 5: Subtitle display */
  .slot-subtitle { font-size:12px; font-style:italic; color:var(--text-muted); margin-top:2px; width:100%; }
  .slot-time { font-weight:700; color:var(--text-muted); }
  .slot-badge { padding:2px 8px; border-radius:9999px; background:var(--agenda-accent); color:var(--se-white); font-size:12px; font-weight:800; }
  .slot-progress { margin-top:8px; width:100%; height:8px; background:var(--agenda-progress-bg); border-radius:9999px; overflow:hidden; }
  .slot-progress > div { height:100%; background:var(--agenda-accent); width:0%; transition:width .3s; }
  .slot-items { margin-top:8px; display:flex; flex-direction:column; gap:8px; min-height:34px; border:1.5px dashed var(--border); border-radius:8px; padding:8px; }
  .slot-items.drag-over { background:var(--surface-alt); border-color:var(--agenda-accent); }

  .slot-item { display:flex; align-items:center; gap:8px; background:var(--surface); border:1.5px solid var(--se-life-green); border-radius:8px; padding:10px 12px; cursor:grab; transition:all .15s; box-shadow:0 2px 4px rgba(61,205,88,0.1); }
  .slot-item:hover { background:var(--surface-alt); box-shadow:0 4px 8px rgba(61,205,88,0.15); transform:translateY(-1px); }
  .slot-item .si-name { font-weight:700; color:var(--text); flex:1; cursor:pointer; font-size:14px; }
  .slot-item .si-name:hover { color:var(--se-life-green); }
  .slot-item .si-type { font-size:11px; color:var(--se-white); font-weight:800; background:var(--se-life-green); padding:2px 8px; border-radius:10px; text-transform:uppercase; }
  .slot-item .si-x { width:22px; height:22px; border-radius:6px; border:1.5px solid var(--border); color:var(--text-muted); background:var(--se-white); cursor:pointer; display:flex; align-items:center; justify-content:center; font-weight:900; line-height:1; font-size:14px; }
  .slot-item .si-x:hover { background:var(--surface-alt); border-color:var(--se-life-green); color:var(--se-life-green); }
  .slot-item.dragging { opacity:.6; }

  /* FEATURE: Highlight currently playing media in agenda */
  .slot-item.active-media {
    background:var(--se-life-green) !important;
    color:var(--se-white);
    border-color:var(--se-life-green);
    box-shadow:0 4px 12px rgba(61,205,88,0.3);
  }
  .slot-item.active-media .si-name { color:var(--se-white) !important; }
  .slot-item.active-media .si-type { background:var(--se-white); color:var(--se-life-green); }
  .slot-item.active-media .si-x { background:rgba(255,255,255,0.9); }


  /* FEATURE: Custom media types (text, link, photo) */
  .slot-item .si-type.type-text { background:#3b82f6; }
  .slot-item .si-type.type-link { background:#f97316; }
  .slot-item .si-type.type-photo { background:#a855f7; }
  
  /* Quick actions container (+ button and dropdown) */
  .quick-actions-container {
    margin-top:8px; display:flex; gap:6px; align-items:flex-start; position:relative;
  }
  .quick-actions-container .add-custom-btn,
  .quick-actions-container .quick-assign-btn {
    width:28px; height:28px; padding:0; border-radius:50%;
    background:var(--se-life-green); color:var(--se-white);
    border:none; cursor:pointer; display:flex; align-items:center; justify-content:center;
    transition:all .15s; flex-shrink:0;
  }
  .quick-actions-container .add-custom-btn:hover,
  .quick-actions-container .quick-assign-btn:hover {
    background:var(--se-dark-gray); transform:scale(1.1);
  }
  .quick-actions-container .custom-media-menu {
    position:absolute; top:32px; left:0; z-index:1000;
    background:var(--se-white); border:1.5px solid var(--border);
    border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15);
    display:none; flex-direction:column; gap:0; min-width:140px;
  }
  .quick-actions-container .custom-media-menu button {
    padding:10px 14px; border:none; background:transparent;
    text-align:left; font-size:13px; font-weight:600; cursor:pointer;
    color:var(--text); transition:background .15s;
    border-bottom:1px solid var(--border);
  }
  .quick-actions-container .custom-media-menu button:last-child {
    border-bottom:none;
  }
  .quick-actions-container .custom-media-menu button:hover {
    background:var(--surface-alt);
  }
  
  /* Quick assign dropdown menu */
  .quick-actions-container .quick-assign-menu {
    position:absolute; top:32px; left:36px; z-index:1000;
    background:var(--se-white); border:1.5px solid var(--border);
    border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15);
    display:none; min-width:200px; max-width:300px;
    max-height:400px; overflow-y:auto;
  }
  .quick-assign-section {
    padding:8px 0;
  }
  .quick-assign-section:not(:last-child) {
    border-bottom:1px solid var(--border);
  }
  .quick-assign-label {
    padding:6px 12px; font-size:11px; font-weight:800;
    color:var(--text-muted); text-transform:uppercase;
  }
  .quick-assign-item {
    width:100%; padding:8px 12px; border:none; background:transparent;
    text-align:left; font-size:13px; font-weight:600; cursor:pointer;
    color:var(--text); transition:background .15s;
  }
  .quick-assign-item:hover {
    background:var(--surface-alt);
  }
  .quick-assign-empty {
    padding:8px 12px; font-size:12px; color:var(--text-muted);
    font-style:italic;
  }
  
  /* Legacy styles for custom media forms */
  .custom-media-add {
    margin-top:8px; display:flex; gap:8px; align-items:flex-start; position:relative;
  }
  .custom-media-add select {
    padding:6px 10px; border-radius:6px; border:1.5px solid var(--border);
    font-size:13px; font-weight:600; cursor:pointer;
  }
  .custom-media-add button {
    padding:6px 12px; border-radius:6px; border:none;
    background:var(--se-life-green); color:var(--se-white);
    font-weight:700; font-size:13px; cursor:pointer;
  }
  .custom-media-add button:hover { opacity:0.9; }
  .custom-media-add .cancel-btn {
    background:var(--se-dark-gray);
  }
  
  .custom-media-form {
    margin-top:8px; padding:10px; background:var(--surface-alt);
    border-radius:8px; border:1.5px solid var(--border);
  }
  .custom-media-form input, .custom-media-form textarea {
    width:100%; padding:8px; margin-bottom:8px;
    border:1.5px solid var(--border); border-radius:6px;
    font-size:13px;
  }
  .custom-media-form textarea {
    min-height:60px; resize:vertical; font-family:inherit;
  }
  .custom-media-form-actions {
    display:flex; gap:8px;
  }
  .custom-media-form-actions button {
    flex:1; padding:8px; border:none; border-radius:6px;
    font-weight:700; font-size:13px; cursor:pointer;
  }
  .custom-media-form-actions .add-btn {
    background:var(--se-life-green); color:var(--se-white);
  }
  .custom-media-form-actions .cancel-btn {
    background:var(--se-dark-gray); color:var(--se-white);
  }
  
  .slot-item .photo-thumbnail {
    width:40px; height:40px; object-fit:cover;
    border-radius:4px; margin-right:8px;
  }
  .slot-item .link-icon {
    color:var(--se-life-green); text-decoration:none;
    font-size:16px; margin-left:4px;
  }


  .toast { position:fixed; top:16px; left:50%; transform:translateX(-50%) translateY(-16px); background:var(--se-life-green); color:var(--se-white); padding:10px 14px; border-radius:10px; box-shadow:0 10px 25px rgba(0,0,0,.15); opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:3000; font-weight:700; }
  .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

  /* NEW FEATURE: Full-screen Agenda Display */
  .agenda-display-overlay {
    position:fixed; inset:0; background:rgba(0,0,0,0.92);
    display:none; align-items:center; justify-content:center; z-index:9999;
    backdrop-filter:blur(4px); animation:fadeIn 0.3s;
  }
  .agenda-display-overlay.show { display:flex; }
  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
  

  .agenda-display-content {
    background:var(--se-white); border-radius:20px;
    max-width:900px; width:90%; max-height:90vh;
    padding:50px; overflow:auto; box-shadow:0 20px 60px rgba(0,0,0,0.5);
    position:relative;
  }
  .agenda-display-logo {
    text-align:center; margin-bottom:35px;
  }
  .agenda-display-logo img {
    max-width:250px; height:auto;
  }
  .agenda-display-actions {
    display:flex; gap:16px; justify-content:center;
    margin-bottom:40px;
  }
  .agenda-display-actions button {
    padding:12px 24px; border-radius:10px;
    border:2px solid var(--se-life-green); background:var(--se-white);
    font-weight:700; font-size:15px; cursor:pointer;
    display:flex; align-items:center; gap:10px;
    transition:all .15s; color:var(--text);
  }
  .agenda-display-actions button:hover {
    background:var(--se-life-green); color:var(--se-white);
    border-color:var(--se-life-green);
  }
  .agenda-display-actions button svg {
    width:20px; height:20px;
  }
  
  /* Print styles - Optimized for A4 color printing */
  @media print {
    * { -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; }
    
    .agenda-display-overlay { background:white !important; }
    .agenda-display-close, .agenda-display-actions { display:none !important; }
    .agenda-display-content { 
      box-shadow:none !important; max-width:100% !important; width:100% !important;
      padding:20mm 15mm !important; max-height:none !important; overflow:visible !important;
      border-radius:0 !important;
    }
    
    /* Logo */
    .agenda-display-logo { margin-bottom:20px !important; }
    .agenda-display-logo img { max-width:180px !important; }
    
    /* Header */
    .agenda-display-header { margin-bottom:25px !important; padding-bottom:15px !important; }
    .agenda-display-header h2 { font-size:28px !important; margin-bottom:8px !important; color:#626469 !important; }
    .agenda-display-header .timezone { font-size:14px !important; color:#9FA0A4 !important; }
    .agenda-display-header { border-bottom:3px solid #3DCD58 !important; }
    
    /* Slots */
    .agenda-display-slot {
      page-break-inside:avoid !important;
      margin-bottom:18px !important; padding:16px 20px !important;
      background:#F7F7F7 !important;
      border-left:4px solid #3DCD58 !important;
      border-radius:8px !important;
      box-shadow:none !important;
    }
    .agenda-display-slot-title { font-size:18px !important; margin-bottom:8px !important; color:#1f2937 !important; }
    .agenda-display-slot-subtitle { font-size:14px !important; margin-bottom:10px !important; color:#9FA0A4 !important; }
    .agenda-display-slot-time { 
      font-size:13px !important; margin-bottom:12px !important; 
      background:white !important; padding:5px 12px !important;
      color:#626469 !important;
    }
    
    /* Items */
    .agenda-display-items { gap:8px !important; }
    .agenda-display-item {
      padding:10px 14px !important; gap:10px !important;
      background:white !important; border:1.5px solid #e5e7eb !important;
      border-radius:6px !important;
    }
    .agenda-display-item-badge {
      padding:4px 10px !important; font-size:10px !important;
      border-radius:6px !important;
      background:#3DCD58 !important; color:white !important;
    }
    .agenda-display-item-name { font-size:13px !important; color:#1f2937 !important; }
    
    /* Ensure all background colors print */
    body, html { height:auto !important; background:white !important; }
  }

  .agenda-display-close {
    position:absolute; top:20px; right:20px;
    background:transparent; border:none; font-size:32px;
    line-height:1; cursor:pointer; color:var(--se-dark-gray);
    font-weight:800; transition:color .15s;
  }
  .agenda-display-close:hover { color:var(--se-black); }
  
  .agenda-display-header {
    text-align:center; margin-bottom:45px;
    padding-bottom:25px; border-bottom:4px solid var(--se-life-green);
  }
  .agenda-display-header h2 {
    font-size:42px; font-weight:900; color:var(--se-dark-gray);
    margin-bottom:10px; letter-spacing:-0.5px;
  }
  .agenda-display-header .timezone {
    font-size:18px; color:var(--text-muted); font-weight:600;
  }
  
  .agenda-display-slot {
    margin-bottom:30px; padding:28px 32px; background:var(--surface-alt);
    border-radius:14px; border-left:5px solid var(--se-life-green);
    box-shadow:0 2px 8px rgba(0,0,0,0.05);
  }
  .agenda-display-slot:last-child { margin-bottom:0; }
  
  .agenda-display-slot-title {
    font-size:24px; font-weight:800; color:var(--text);
    margin-bottom:10px; display:flex; align-items:center; gap:12px;
  }
  .agenda-display-slot-subtitle {
    font-size:18px; font-style:italic; color:var(--text-muted);
    margin-bottom:14px;
  }
  .agenda-display-slot-time {
    font-size:16px; font-weight:700; color:var(--se-dark-gray);
    margin-bottom:18px; background:white; display:inline-block;
    padding:6px 14px; border-radius:20px;
  }
  .agenda-display-items {
    display:flex; flex-direction:column; gap:12px;
  }
  .agenda-display-item {
    display:flex; align-items:center; gap:14px;
    padding:14px 18px; background:var(--se-white);
    border-radius:10px; border:2px solid var(--border);
    transition:all 0.15s;
  }
  .agenda-display-item:hover {
    border-color:var(--se-life-green);
    box-shadow:0 2px 8px rgba(61,205,88,0.15);
  }
  .agenda-display-item-badge {
    padding:6px 12px; border-radius:8px;
    background:var(--se-life-green); color:var(--se-white);
    font-weight:800; font-size:11px; letter-spacing:0.5px;
  }
  .agenda-display-item-name {
    font-size:16px; font-weight:600; color:var(--text); flex:1;
  }
  .agenda-display-empty {
    text-align:center; padding:60px 20px; color:var(--text-muted);
  }
  .agenda-display-empty h3 {
    font-size:24px; margin-bottom:12px;
  }
  .agenda-display-empty p {
    font-size:16px;
  }


  /* FEATURE: Floating assign toolbar (outside menu) */
  .floating-assign-toolbar {
    position:fixed; z-index:300;
    background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);
    border:2px solid var(--se-life-green); border-radius:12px;
    padding:12px 16px; box-shadow:0 8px 24px rgba(0,0,0,0.15);
    display:none; align-items:center; gap:12px;
    min-width:350px;
  }
  .floating-assign-toolbar.show { display:flex; }
  .floating-assign-toolbar .toolbar-label {
    font-weight:700; font-size:14px; color:var(--text);
  }
  .floating-assign-toolbar select {
    flex:1; padding:8px 12px; border-radius:8px;
    border:1.5px solid var(--border); font-size:13px;
    font-weight:600; cursor:pointer;
  }
  .floating-assign-toolbar button {
    padding:8px 16px; border-radius:8px; border:none;
    font-weight:700; font-size:13px; cursor:pointer;
    transition:all .15s;
  }
  .floating-assign-toolbar .assign-btn {
    background:var(--se-life-green); color:var(--se-white);
  }
  .floating-assign-toolbar .assign-btn:hover { opacity:0.9; }
  .floating-assign-toolbar .clear-btn {
    background:var(--se-dark-gray); color:var(--se-white);
  }
  .floating-assign-toolbar .clear-btn:hover { opacity:0.9; }


  @media (max-width:768px) { .modal-body{ grid-template-columns:1fr } }
</style>
</head>
<body>
  <!-- Inline fallback Quartz-like icon sprite -->
  <svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true">
    <symbol id="repeat" viewBox="0 0 24 24">
      <path d="M17 2l3 3-3 3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M3 5h14a4 4 0 0 1 4 4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M7 22l-3-3 3-3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M21 19H7a4 4 0 0 1-4-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    <symbol id="repeat-1" viewBox="0 0 24 24">
      <use href="#repeat"></use>
      <text x="12" y="14" font-size="8" text-anchor="middle" fill="currentColor">1</text>
    </symbol>
    <symbol id="maximize" viewBox="0 0 24 24">
      <path d="M9 3H5a2 2 0 0 0-2 2v4M21 9V5a2 2 0 0 0-2-2h-4M3 15v4a2 2 0 0 0 2 2h4M21 15v4a2 2 0 0 1-2 2h-4" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="minimize" viewBox="0 0 24 24">
      <path d="M9 9H5v4M15 9h4v4M9 15H5v4M19 15h-4v4" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="settings" viewBox="0 0 24 24">
      <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 3.4 15a1.65 1.65 0 0 0-1.51-1H1a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 3.4 8a1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 5.84 3.3l.06.06A1.65 1.65 0 0 0 8 3.6a1.65 1.65 0 0 0 1-1.51V1a2 2 0 1 1 4 0v.09A1.65 1.65 0 0 0 16 3.4a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 8c.36.54.56 1.18.56 1.84 0 .66-.2 1.3-.56 1.84Z" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="chevron-left" viewBox="0 0 24 24">
      <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <symbol id="plus" viewBox="0 0 24 24">
      <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    <symbol id="list" viewBox="0 0 24 24">
      <path d="M3 6h13M3 12h9M3 18h5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    <symbol id="film" viewBox="0 0 24 24">
      <rect x="3" y="5" width="18" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M7 10h10M7 14h6" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="file" viewBox="0 0 24 24">
      <rect x="3" y="4" width="18" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M7 8h10M7 12h10M7 16h6" fill="none" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="play" viewBox="0 0 24 24">
      <path d="M8 5v14l11-7z" fill="currentColor"/>
    </symbol>
    <symbol id="layout-left" viewBox="0 0 24 24">
      <rect x="3" y="4" width="6" height="16" fill="currentColor"/>
      <rect x="9" y="4" width="12" height="16" fill="currentColor" opacity=".35"/>
    </symbol>
    <symbol id="layout-top" viewBox="0 0 24 24">
      <rect x="3" y="4" width="18" height="6" fill="currentColor"/>
      <rect x="3" y="10" width="18" height="10" fill="currentColor" opacity=".35"/>
    </symbol>
    <symbol id="layout-right" viewBox="0 0 24 24">
      <rect x="15" y="4" width="6" height="16" fill="currentColor"/>
      <rect x="3" y="4" width="12" height="16" fill="currentColor" opacity=".35"/>
    </symbol>
    <symbol id="layout-bottom" viewBox="0 0 24 24">
      <rect x="3" y="16" width="18" height="4" fill="currentColor"/>
      <rect x="3" y="4" width="18" height="12" fill="currentColor" opacity=".35"/>
    </symbol>
    <symbol id="menu" viewBox="0 0 24 24">
      <line x1="3" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="3" y1="6" x2="21" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="3" y1="18" x2="21" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    <symbol id="search" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    <symbol id="calendar" viewBox="0 0 24 24">
      <rect x="3" y="4" width="18" height="18" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
      <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
    </symbol>
    <symbol id="lock" viewBox="0 0 24 24">
      <rect x="5" y="11" width="14" height="10" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M8 11V7a4 4 0 0 1 8 0v4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <circle cx="12" cy="16" r="1.5" fill="currentColor"/>
    </symbol>
    <symbol id="unlock" viewBox="0 0 24 24">
      <rect x="5" y="11" width="14" height="10" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
      <path d="M8 11V7a4 4 0 0 1 7.5-2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <circle cx="12" cy="16" r="1.5" fill="currentColor"/>
    </symbol>
    <symbol id="trash" viewBox="0 0 24 24">
      <polyline points="3 6 5 6 21 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="10" y1="11" x2="10" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="14" y1="11" x2="14" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </symbol>
    <symbol id="presentation" viewBox="0 0 24 24">
      <rect x="2" y="3" width="20" height="14" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
      <line x1="12" y1="17" x2="12" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <line x1="8" y1="21" x2="16" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      <path d="M8 10l3 3 5-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
  </svg>

  <!-- Skip link -->
  <a href="#mainContent" class="skip-link">Skip to main content</a>

  <!-- FEATURE 6: Menu toggle button -->
  <button class="menu-toggle-btn left" id="menuToggleBtn" title="Toggle Menu" aria-label="Toggle menu visibility">
    <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#menu"></use></svg>
  </button>

  <div id="app">
    <div class="menu-panel left" id="menuPanel">
      <div class="logo-header" id="logoHeader">
        <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/690c69865326fb0651506b4f/72916fdb4_logo.png" alt="Schneider Electric">
      </div>

      <div class="resize-handle" id="resizeHandle"></div>

      <div class="menu-content">
        <!-- Meeting mode: clock and Agenda -->
        <div class="menu-section" id="agendaSection" style="display:none">
          <div class="menu-label">
            <span>Agenda</span>
            <span class="label-actions">
              <!-- NEW: Full-screen Agenda Display button -->
              <button class="icon-btn" id="showFullAgendaBtn" title="Show Full Agenda" aria-label="Show Full Agenda Display">
                <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#presentation"></use></svg>
              </button>
              <!-- NEW: Build Agenda button -->
              <button class="icon-btn" id="buildAgendaBtn" title="Build Agenda" aria-label="Build Agenda">
                <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#calendar"></use></svg>
              </button>
              <!-- Lock/Unlock agenda button -->
              <button class="icon-btn" id="lockAgendaBtn" title="Lock Agenda" aria-label="Lock/Unlock Agenda">
                <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#unlock"></use></svg>
              </button>
            </span>
          </div>
          <div class="gmt-clock">
            <span id="tzLabel">Current time (CET)</span>
            <span id="gmtClockValue">--:--:--</span>
          </div>
          <div class="agenda-panel" id="agendaPanel"></div>
          <div class="helper-text">Drag videos or presentations into a slot. Click an item to open it. Use the small × to remove.</div>
          
          <!-- NEW: Multi-select assignment toolbar for Meeting mode -->
          <div class="multi-select-toolbar" id="multiSelectToolbar" style="display:none">
            <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
              <span style="font-size:13px;font-weight:700;color:var(--text-muted)">Assign selected to:</span>
              <select id="slotAssignDropdown" class="compact-dropdown" style="flex:1;max-width:200px">
                <option value="">Select slot...</option>
              </select>
              <button class="icon-btn" id="clearSelectionBtn" title="Clear selection">
                <svg viewBox="0 0 24 24"><use href="#plus" style="transform:rotate(45deg)"></use></svg>
              </button>
            </div>
          </div>
        </div>

        <div class="menu-section" id="videosSection">
          <div class="menu-label">
            <span id="videoLabel">Videos</span>
            <span class="label-actions">
              <button class="icon-btn" id="loopModeBtn" title="Loop mode: Single video" aria-label="Toggle loop mode">
                <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#repeat-1"></use></svg>
              </button>
            </span>
          </div>

          <!-- FEATURE 2: Search bar for videos -->
          <div class="search-container">
            <input type="text" id="videoSearchInput" class="search-input" placeholder="Search videos..." aria-label="Search videos">
          </div>

          <div class="compact-row" id="videoCompactRow">
            <label style="font-weight:700;color:var(--text-muted)">Current video</label>
            <select id="videoSelectCompact" class="compact-select"></select>
          </div>
          
          <!-- NEW: Combined dropdown for top/bottom menu -->
          <div class="compact-row combined-media-row" id="combinedMediaRow" style="display:none">
            <label style="font-weight:700;color:var(--text-muted);margin-right:8px">Media</label>
            <select id="combinedMediaSelect" class="compact-select" style="flex:1">
              <option value="">Select media...</option>
            </select>
          </div>

          <div class="file-list" id="videoList"></div>
          <div class="helper-text" id="videoHelperText">No videos loaded. Add videos in Settings.</div>
        </div>

        <div class="menu-section" id="presentationsSection">
          <div class="menu-label">
            <span id="presentationLabel">Presentations</span>
          </div>

          <!-- FEATURE 2: Search bar for presentations -->
          <div class="search-container">
            <input type="text" id="presentationSearchInput" class="search-input" placeholder="Search presentations..." aria-label="Search presentations">
          </div>

          <div class="compact-row" id="presentationCompactRow">
            <label style="font-weight:700;color:var(--text-muted)">Current presentation</label>
            <select id="presentationSelectCompact" class="compact-select"></select>
          </div>

          <div class="file-list" id="presentationList"></div>
          <div class="helper-text" id="presentationHelperText">No presentations loaded. Add PDFs in Settings.</div>
        </div>
      </div>

      <div class="menu-footer">
        <!-- Settings button - always visible -->
        <button class="icon-btn" id="settingsBtn" title="Settings" aria-label="Settings">
          <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#settings"></use></svg>
        </button>
      </div>
    </div>

    <div class="main-content left" id="mainContent">
      <!-- Back navigation button (overlaid, opposite to menu toggle) -->
      <button class="nav-back-btn" id="navBackBtn" title="Switch Media" aria-label="Switch to other media type">
        <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#chevron-left"></use></svg>
      </button>
      
      <!-- Floating fullscreen button (near back button) -->
      <button class="floating-fullscreen-btn" id="floatingFullscreenBtn" title="Toggle Fullscreen" aria-label="Toggle fullscreen">
        <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#maximize"></use></svg>
      </button>

      <div class="video-container" id="videoContainer" style="display:none">
        <video id="videoPlayer" controls></video>
      </div>

      <div class="presentation-container" id="presentationContainer">
        <div class="pdf-canvas-wrapper">
          <canvas id="pdfCanvas"></canvas>
          <!-- Modern compact controls overlaid at bottom -->
          <div class="presentation-controls">
            <button id="prevPageBtn" title="Previous page">← Prev</button>
            <span class="page-info" id="pageInfo">Page</span>
            <button id="nextPageBtn" title="Next page">Next →</button>
          </div>
        </div>
      </div>

      <div class="empty-state" id="emptyState" style="display:flex">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:64px;height:64px;margin-bottom:12px;opacity:.5" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
        <div style="text-align:center;color:white;padding:8px">
          <h3 style="margin-bottom:6px">No media selected</h3>
          <p style="color:#d1d5db">Please add videos or PDFs in Settings</p>
        </div>
      </div>
    </div>

    <!-- Settings modal -->
    <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
      <div class="modal-dialog" role="dialog" aria-labelledby="settingsTitle" aria-modal="true">
        <div class="modal-header">
          <div class="modal-title" id="settingsTitle" style="display:flex;align-items:center;gap:10px">
            <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#settings"></use></svg>
            <span>Settings</span>
          </div>
          <!-- NEW: Tabs moved to header -->
          <div class="settings-tabs">
            <button class="settings-tab active" data-tab="general">General</button>
            <button class="settings-tab" data-tab="media">Media Library</button>
          </div>
          <button class="modal-close" id="modalClose" title="Close" aria-label="Close settings">×</button>
        </div>
        <div class="modal-body tabbed">

          <!-- General Tab -->
          <div class="tab-content active" id="generalTab">
          <!-- Mode + Time zone -->
          <div class="modal-section">
            <div class="section-title" style="display:flex;align-items:center;gap:10px">
              <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#layout-left"></use></svg>
              <span>Mode</span>
            </div>
            <div class="inline-control" role="group" aria-label="Application mode">
              <label style="display:flex;align-items:center;gap:8px;font-weight:700;color:var(--text)">
                <input type="radio" name="appMode" value="presentation" id="modePresentation"> Presentation mode
              </label>
              <label style="display:flex;align-items:center;gap:8px;font-weight:700;color:var(--text)">
                <input type="radio" name="appMode" value="meeting" id="modeMeeting"> Meeting mode
              </label>
            </div>
            <div class="helper-text">Presentation: behaves like today. Meeting: fixed left menu with agenda slots and live time tracking.</div>

            <div class="section-title" style="margin-top:14px;display:flex;align-items:center;gap:10px">
              <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#list"></use></svg>
              <span>Meeting Agenda</span>
            </div>

            <!-- New: Time Zone selector -->
            <div class="inline-control" style="gap:8px;margin-bottom:8px">
              <label for="timeZoneSelect" style="font-weight:800;color:var(--text-muted)">Time zone</label>
              <select id="timeZoneSelect" class="sort-select" title="Agenda time zone">
                <option value="Europe/Paris">CET/CEST (Europe/Paris)</option>
                <option value="UTC">UTC</option>
                <option value="Europe/London">Europe/London</option>
                <option value="America/New_York">America/New_York</option>
                <option value="America/Los_Angeles">America/Los_Angeles</option>
                <option value="Asia/Dubai">Asia/Dubai</option>
                <option value="Asia/Tokyo">Asia/Tokyo</option>
                <option value="Australia/Sydney">Australia/Sydney</option>
              </select>
            </div>

            <div class="agenda-builder" id="agendaBuilder">
              <!-- header row -->
              <div class="agenda-row" style="font-weight:800;color:var(--text-muted);grid-template-columns:40px 1fr 140px 140px 100px 40px">
                <div></div><div>Title</div><div>Start (HH:MM)</div><div>End (HH:MM)</div><div>Duration (min)</div><div></div>
              </div>
              <div id="agendaRows"></div>
              <div class="add-slot-row">
                <button class="add-quick" id="addSlot15Btn" type="button">+ 15 min</button>
                <button class="add-quick" id="addSlot30Btn" type="button">+ 30 min</button>
                <button class="add-quick" id="addSlot60Btn" type="button">+ 1 hour</button>
              </div>
              <div class="helper-text">
                Drag rows (⋮⋮) to reorder. The moved slot takes the time of the position it moves into (e.g., moving to slot #2 takes slot #2's time). Only the first slot's Start is editable. Changing any End re-chains the following starts.
              </div>
            </div>
          </div>

          <!-- Menu Position -->
          <div class="modal-section">
            <div class="section-title" style="display:flex;align-items:center;gap:10px">
              <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#layout-left"></use></svg>
              <span>Menu Position</span>
            </div>
            <div class="position-buttons" id="positionButtons" style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="icon-btn position-btn active" data-position="left" aria-pressed="true" title="Left"><svg viewBox="0 0 24 24"><use href="#layout-left"></use></svg></button>
              <button class="icon-btn position-btn" data-position="top" aria-pressed="false" title="Top"><svg viewBox="0 0 24 24"><use href="#layout-top"></use></svg></button>
              <button class="icon-btn position-btn" data-position="right" aria-pressed="false" title="Right"><svg viewBox="0 0 24 24"><use href="#layout-right"></use></svg></button>
              <button class="icon-btn position-btn" data-position="bottom" aria-pressed="false" title="Bottom"><svg viewBox="0 0 24 24"><use href="#layout-bottom"></use></svg></button>
            </div>
            <div class="helper-text" id="positionHelper">Use these buttons to change menu position.</div>
          </div>
          </div>
          <!-- End General Tab -->

          <!-- Media Library Tab -->
          <div class="tab-content" id="mediaTab">
            <!-- Videos -->
          <div class="modal-section">
            <div class="section-title" style="display:flex;align-items:center;gap:10px">
              <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#film"></use></svg>
              <span>Videos</span>
            </div>
            <div class="inline-control">
              <button class="file-picker" id="videoAddBtn" title="Add Videos" style="display:inline-flex;align-items:center;gap:8px">
                <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#plus"></use></svg>
                Add Videos
              </button>
              <!-- NEW: Clear All Videos button -->
              <button class="file-picker danger" id="videoClearBtn" title="Clear All Videos" style="display:inline-flex;align-items:center;gap:8px">
                <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#trash"></use></svg>
                Clear All
              </button>
              <label for="videoSortSelectModal" class="helper-text" style="margin:0;display:inline-flex;align-items:center;gap:6px">
                <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true"><use href="#list"></use></svg>
                Sort
              </label>
              <select id="videoSortSelectModal" class="sort-select" title="Sort videos">
                <option value="custom">Custom (Manual)</option>
                <option value="nameAsc">Name A–Z</option>
                <option value="nameDesc">Name Z–A</option>
                <option value="naturalAsc">Numeric 0–9</option>
                <option value="naturalDesc">Numeric 9–0</option>
                <option value="addedDesc">Recently Added</option>
                <option value="addedAsc">Oldest Added</option>
              </select>
            </div>
            <input id="videoInputAdd" type="file" accept="video/*" multiple style="display:none" aria-hidden="true">
            <div class="mini-list" id="modalVideoList"></div>
            <div class="helper-text">Click name to rename, drag to reorder</div>
            
            <!-- Playback (moved to be with Videos) -->
            <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
              <div style="display:flex;gap:12px;align-items:center">
                <div class="toggle-wrap" id="loopToggle" role="button" aria-pressed="true" title="Toggle loop" tabindex="0" style="display:flex;gap:10px;align-items:center;cursor:pointer">
                  <div id="loopSwitch" style="width:38px;height:22px;border-radius:22px;background:var(--se-life-green);position:relative;transition:background .2s">
                    <div style="position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:var(--se-white);transition:left .2s" id="loopSwitchKnob"></div>
                  </div>
                  <span id="loopLabel" style="color:var(--text-muted);font-weight:700">Loop: On</span>
                </div>
              </div>
              <div class="helper-text" style="margin-top:4px">Controls video playback loop behavior</div>
            </div>
          </div>

          <!-- Presentations -->
          <div class="modal-section">
            <div class="section-title" style="display:flex;align-items:center;gap:10px">
              <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#file"></use></svg>
              <span>Presentations</span>
            </div>
            <div class="inline-control">
              <button class="file-picker" id="presentationAddBtn" title="Add Presentations (.pdf)" style="display:inline-flex;align-items:center;gap:8px">
                <svg viewBox="0 0 24 24" aria-hidden="true"><use href="#plus"></use></svg>
                Add Presentations (.pdf)
              </button>
              <label for="presSortSelectModal" class="helper-text" style="margin:0;display:inline-flex;align-items:center;gap:6px">
                <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true"><use href="#list"></use></svg>
                Sort
              </label>
              <select id="presSortSelectModal" class="sort-select" title="Sort presentations">
                <option value="custom">Custom (Manual)</option>
                <option value="nameAsc">Name A–Z</option>
                <option value="nameDesc">Name Z–A</option>
                <option value="naturalAsc">Numeric 0–9</option>
                <option value="naturalDesc">Numeric 9–0</option>
                <option value="addedDesc">Recently Added</option>
                <option value="addedAsc">Oldest Added</option>
              </select>
            </div>
            <input id="presentationInputAdd" type="file" accept=".pdf" multiple style="display:none" aria-hidden="true">
            <div class="mini-list" id="modalPresentationList"></div>
            <div class="helper-text">Click name to rename, drag to reorder</div>
          </div>
          </div>
          <!-- End Media Library Tab -->
        </div>
      </div>
    </div>

  </div>

  <!-- Toast container -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- NEW FEATURE: Floating Assignment Toolbar (outside menu, always visible) -->
  <div class="floating-assign-toolbar" id="floatingAssignToolbar" style="display:none">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <span id="floatingToolbarLabel" style="font-size:14px;font-weight:700;color:var(--text)">0 items selected</span>
      <select id="floatingSlotDropdown" class="compact-dropdown" style="flex:1;min-width:180px">
        <option value="">Select slot...</option>
      </select>
      <button class="icon-btn" id="floatingAssignBtn" title="Assign to slot">
        <svg viewBox="0 0 24 24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
      </button>
      <button class="icon-btn" id="floatingClearBtn" title="Clear selection">
        <svg viewBox="0 0 24 24"><use href="#plus" style="transform:rotate(45deg)"></use></svg>
      </button>
    </div>
  </div>

  <!-- NEW FEATURE: Full-screen Agenda Display Overlay -->
  <div class="agenda-display-overlay" id="agendaDisplayOverlay">
    <div class="agenda-display-content">
      <button class="agenda-display-close" id="agendaDisplayClose" aria-label="Close">×</button>
      <div id="agendaDisplayBody"></div>
    </div>
  </div>

<script>
(function(){
  'use strict';

  const ICON_SPRITE_URL = ''; // optional external sprite

  function tryAttachQuartzSprite(){
    if (!ICON_SPRITE_URL) return;
    document.querySelectorAll('svg use[href^="#"]').forEach(use=>{
      const id = use.getAttribute('href'); if (!id) return;
      use.setAttribute('href', ICON_SPRITE_URL + id);
    });
  }

  if (window.pdfjsLib) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }

  const DEFAULT_MENU_WIDTH = 340;
  const DEFAULT_MENU_HEIGHT = 100;
  const STORAGE_KEY = 'smo_v6_state';
  const ONBOARDED_KEY = 'smo_v6_onboarded';

  const MIN_SLOT_MINUTES = 15;

  // State
  let menuPos = 'left';
  let appMode = 'presentation'; // 'presentation' | 'meeting'
  // New: Time zone (default CET/Europe-Paris)
  let timeZone = 'Europe/Paris';
  // FEATURE 6: Menu visibility state
  let menuVisible = true;

  let videoFiles = [];        // { file, _id, _customName, _addedAt, _duration }
  let presentationFiles = []; // { file, _id, _customName, _currentPage, _arrayBuffer, _addedAt }
  let currentVideoIndex = -1;
  let currentVideoUrl = null;

  // Meeting agenda
  // slots: [{id,title,subtitle,start:"HH:MM",end:"HH:MM", items:[{id,type:'video'|'pdf'}]}]
  let agendaSlots = [];

  // Loop settings
  let loopMode = true;
  let loopModeType = 'single'; // 'single' | 'playlist'

  let presentationIndex = -1;
  let activeView = null; // 'video' | 'presentation' | null
  let pdfDoc = null;
  let currentPage = 1;
  let pdfLoadToken = 0;

  // Sort modes
  let sortModeVideos = 'custom';
  let sortModePresentations = 'custom';

  // DOM refs
  const menuPanel = document.getElementById('menuPanel');
  const mainContent = document.getElementById('mainContent');

  const videoList = document.getElementById('videoList');
  const presentationList = document.getElementById('presentationList');
  const videoContainer = document.getElementById('videoContainer');
  const presentationContainer = document.getElementById('presentationContainer');
  const emptyState = document.getElementById('emptyState');
  const videoPlayer = document.getElementById('videoPlayer');

  const loopModeBtn = document.getElementById('loopModeBtn');
  const fullscreenBtns = Array.from(document.querySelectorAll('.fullscreen-btn'));
  const floatingFullscreenBtn = document.getElementById('floatingFullscreenBtn');
  if (floatingFullscreenBtn) fullscreenBtns.push(floatingFullscreenBtn);

  const settingsBtn = document.getElementById('settingsBtn');
  const modalOverlay = document.getElementById('modalOverlay');
  const modalClose = document.getElementById('modalClose');

  // Mode controls in settings
  const modePresentation = document.getElementById('modePresentation');
  const modeMeeting = document.getElementById('modeMeeting');
  const positionButtonsWrap = document.getElementById('positionButtons');
  const positionHelper = document.getElementById('positionHelper');

  // Time zone controls
  const timeZoneSelect = document.getElementById('timeZoneSelect');
  const tzLabel = document.getElementById('tzLabel');

  // Agenda (settings)
  const agendaRows = document.getElementById('agendaRows');
  const addSlot15Btn = document.getElementById('addSlot15Btn');
  const addSlot30Btn = document.getElementById('addSlot30Btn');
  const addSlot60Btn = document.getElementById('addSlot60Btn');

  // Agenda (menu)
  const agendaSection = document.getElementById('agendaSection');
  const agendaPanel = document.getElementById('agendaPanel');
  const gmtClockValue = document.getElementById('gmtClockValue');

  // Modal / inputs
  const videoAddBtn = document.getElementById('videoAddBtn');
  const videoInputAdd = document.getElementById('videoInputAdd');
  const modalVideoList = document.getElementById('modalVideoList');

  const presentationAddBtn = document.getElementById('presentationAddBtn');
  const presentationInputAdd = document.getElementById('presentationInputAdd');
  const modalPresentationList = document.getElementById('modalPresentationList');

  // Sort selects (modal only)
  const videoSortSelectModal = document.getElementById('videoSortSelectModal');
  const presSortSelectModal = document.getElementById('presSortSelectModal');

  // Loop (settings)
  const loopToggle = document.getElementById('loopToggle');
  const loopSwitch = document.getElementById('loopSwitch');
  const loopSwitchKnob = document.getElementById('loopSwitchKnob');
  const loopLabel = document.getElementById('loopLabel');

  // Compact selects
  const videoSelectCompact = document.getElementById('videoSelectCompact');
  const presentationSelectCompact = document.getElementById('presentationSelectCompact');
  const combinedMediaSelect = document.getElementById('combinedMediaSelect');
  const combinedMediaRow = document.getElementById('combinedMediaRow');
  const videoCompactRow = document.getElementById('videoCompactRow');
  const presentationCompactRow = document.getElementById('presentationCompactRow');

  // PDF
  const pdfCanvas = document.getElementById('pdfCanvas');
  const pdfCtx = pdfCanvas.getContext('2d');
  const prevPageBtn = document.getElementById('prevPageBtn');
  const nextPageBtn = document.getElementById('nextPageBtn');
  const pageInfo = document.getElementById('pageInfo');

  // NEW: Back navigation button (unified, overlaid)
  const navBackBtn = document.getElementById('navBackBtn');

  // FEATURE 6: Menu toggle
  const menuToggleBtn = document.getElementById('menuToggleBtn');

  // FEATURE 2: Search inputs
  const videoSearchInput = document.getElementById('videoSearchInput');
  const presentationSearchInput = document.getElementById('presentationSearchInput');

  // NEW: Clear and Build Agenda buttons
  const videoClearBtn = document.getElementById('videoClearBtn');
  const buildAgendaBtn = document.getElementById('buildAgendaBtn');

  // NEW: Multi-select UI elements
  const multiSelectToolbar = document.getElementById('multiSelectToolbar');
  const slotAssignDropdown = document.getElementById('slotAssignDropdown');
  const clearSelectionBtn = document.getElementById('clearSelectionBtn');

  // NEW: Track multi-selected items
  let multiSelectedItems = new Set(); // stores {type:'video'|'pdf', id}

  // Resize
  const resizeHandle = document.getElementById('resizeHandle');
  let resizing = false, start = 0, orig = 0;

  // Toast
  const toastEl = document.getElementById('toast');
  let toastTimer = null;
  function showToast(msg){
    if (!toastEl) return;
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toastEl.classList.remove('show'), 2000);
  }

  // NEW FEATURE: Full-screen Agenda Display
  const agendaDisplayOverlay = document.getElementById('agendaDisplayOverlay');
  const agendaDisplayClose = document.getElementById('agendaDisplayClose');
  const agendaDisplayBody = document.getElementById('agendaDisplayBody');
  const showFullAgendaBtn = document.getElementById('showFullAgendaBtn');

  function showFullAgenda(){
    if (!agendaDisplayBody) return;
    
    // Render the full-screen agenda with logo and action buttons
    let html = '<div class="agenda-display-logo">';
    html += '<img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/690c69865326fb0651506b4f/72916fdb4_logo.png" alt="Schneider Electric" />';
    html += '</div>';
    
    html += '<div class="agenda-display-actions">';
    html += '<button id="printAgendaBtn"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M18 3H6v4h12V3zm1 5H5a2 2 0 0 0-2 2v6h3v4h12v-4h3v-6a2 2 0 0 0-2-2zm-1 9H6v-3h12v3z"/></svg>Print</button>';
    html += '<button id="exportPdfBtn"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>Export PDF</button>';
    html += '</div>';
    
    html += '<div class="agenda-display-header">';
    html += '<h2>Meeting Agenda</h2>';
    html += `<div class="timezone">${zoneShortLabel(timeZone)} Time Zone</div>`;
    html += '</div>';
    
    if (!agendaSlots || agendaSlots.length === 0){
      html += '<div class="agenda-display-empty">';
      html += '<h3>No Agenda Items</h3>';
      html += '<p>Add agenda slots in Settings to see them here.</p>';
      html += '</div>';
    } else {
      agendaSlots.forEach(slot => {
        html += '<div class="agenda-display-slot">';
        html += `<div class="agenda-display-slot-title">${slot.title || '(Untitled)'}</div>`;
        if (slot.subtitle){
          html += `<div class="agenda-display-slot-subtitle">${slot.subtitle}</div>`;
        }
        html += `<div class="agenda-display-slot-time">${slot.start || '--:--'} – ${slot.end || '--:--'}</div>`;
        
        if (slot.items && slot.items.length > 0){
          html += '<div class="agenda-display-items">';
          slot.items.forEach(item => {
            let itemName = '(Unknown)';
            let badgeText = '';
            let badgeColor = 'var(--se-life-green)';
            
            if (item.type === 'video'){
              const meta = videoFiles.find(v => v._id === item.id);
              if (meta) itemName = displayName(meta);
              badgeText = 'VIDEO';
            } else if (item.type === 'pdf'){
              const meta = presentationFiles.find(p => p._id === item.id);
              if (meta) itemName = displayName(meta);
              badgeText = 'PDF';
            } else if (item.type === 'text'){
              itemName = item.data.content.substring(0, 50) + (item.data.content.length > 50 ? '...' : '');
              badgeText = 'TEXT';
              badgeColor = '#3b82f6';
            } else if (item.type === 'link'){
              itemName = item.data.name;
              badgeText = '🔗 LINK';
              badgeColor = '#f97316';
            } else if (item.type === 'photo'){
              itemName = item.data.name;
              badgeText = 'PHOTO';
              badgeColor = '#a855f7';
            }
            
            html += '<div class="agenda-display-item">';
            html += `<span class="agenda-display-item-badge" style="background:${badgeColor}">${badgeText}</span>`;
            html += `<span class="agenda-display-item-name">${itemName}</span>`;
            html += '</div>';
          });
          html += '</div>';
        }
        html += '</div>';
      });
    }
    
    agendaDisplayBody.innerHTML = html;
    agendaDisplayOverlay.classList.add('show');
    
    // Attach event listeners for print and export buttons
    const printBtn = document.getElementById('printAgendaBtn');
    const exportBtn = document.getElementById('exportPdfBtn');
    if (printBtn) printBtn.addEventListener('click', ()=> window.print());
    if (exportBtn) exportBtn.addEventListener('click', ()=> {
      window.print();
      // Note: Browser's print dialog allows saving as PDF
    });
  }

  function hideFullAgenda(){
    if (agendaDisplayOverlay) agendaDisplayOverlay.classList.remove('show');
  }

  // Helpers
  let _idCounter = 1;
  const makeId = () => 'f_' + Date.now().toString(36) + '_' + (_idCounter++);
  const ensureId = m => { if (!m._id) m._id = makeId(); };
  const clamp = (v,min,max) => Math.max(min, Math.min(max, v));
  const baseName = f => f.replace(/\.[^/.]+$/,'');
  const displayName = meta => (meta._customName || baseName(meta.file.name));
  
  // FEATURE 1: Format duration for display
  const formatDuration = (seconds) => {
    if (!seconds || isNaN(seconds)) return '';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    if (mins > 0) {
      return `${mins}:${String(secs).padStart(2, '0')}`;
    }
    return `0:${String(secs).padStart(2, '0')}`;
  };

  // FEATURE 1: Extract video duration
  const getVideoDuration = (file) => {
    return new Promise((resolve) => {
      const video = document.createElement('video');
      video.preload = 'metadata';
      video.onloadedmetadata = () => {
        window.URL.revokeObjectURL(video.src);
        resolve(video.duration);
      };
      video.onerror = () => {
        window.URL.revokeObjectURL(video.src);
        resolve(null);
      };
      video.src = URL.createObjectURL(file);
    });
  };

  const naturalCompare = (a,b)=>{
    const ax=[], bx=[];
    a.replace(/(\d+)|(\D+)/g,(_,n,s)=>ax.push([n||Infinity,s||'']));
    b.replace(/(\d+)|(\D+)/g,(_,n,s)=>bx.push([n||Infinity,s||'']));
    while(ax.length && bx.length){
      const an=ax.shift(), bn=bx.shift();
      const nn=(an[0]-bn[0]) || an[1].localeCompare(bn[1], undefined, { sensitivity:'base' });
      if (nn) return nn;
    }
    return ax.length - bx.length;
  };

  const parseHHMM = (t)=> {
    const m = /^([01]\d|2[0-3]):([0-5]\d)$/.exec((t||'').trim());
    if (!m) return null;
    return parseInt(m[1],10)*60 + parseInt(m[2],10);
  };
  const fmtHHMM = (mins)=>{
    const h = Math.floor(mins/60)%24, m = mins%60;
    return String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
  };
  function roundDownTo5(mins){
    return mins - (mins % 5);
  }

  // Time zone helpers
  function tzNowHM(tz){
    const d=new Date();
    const fmt=new Intl.DateTimeFormat('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:tz});
    const parts=fmt.formatToParts(d);
    const get=t=>parts.find(p=>p.type===t)?.value||'00';
    return {h:+get('hour'), m:+get('minute'), s:+get('second')};
  }
  function getNowTZMinutes(){
    const p = tzNowHM(timeZone);
    return p.h*60 + p.m;
  }
  function zoneShortLabel(tz){
    if (tz==='UTC') return 'UTC';
    if (tz==='Europe/Paris') return 'CET'; // covers CET/CEST label
    const map = {
      'Europe/London':'UK',
      'America/New_York':'ET',
      'America/Los_Angeles':'PT',
      'Asia/Dubai':'GST',
      'Asia/Tokyo':'JST',
      'Australia/Sydney':'AET'
    };
    return map[tz] || tz;
  }

  // Persistence
  function saveState(){
    try{
      const state = {
        menuPos,
        appMode,
        loopMode,
        loopModeType,
        sortModeVideos,
        sortModePresentations,
        timeZone, // new
        videos: videoFiles.map(m => ({
          name: m.file.name,
          _customName: m._customName || null,
          _id: m._id,
          _addedAt: m._addedAt || Date.now()
        })),
        presentations: presentationFiles.map(p => ({
          name: p.file.name,
          _customName: p._customName || null,
          _currentPage: p._currentPage || 1,
          _id: p._id,
          _addedAt: p._addedAt || Date.now()
        })),
        agendaSlots
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }catch(e){}
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch(e){ return null; }
  }
  function buildSavedMap(){
    const s = loadState(); if (!s) return {};
    const map={};
    (s.videos||[]).forEach(v=> map[v.name]=v);
    (s.presentations||[]).forEach(p=> map[p.name]=Object.assign(map[p.name]||{}, p));
    return map;
  }

  // Layout / font scaling
  function applyMenuFontScale(){
    try{
      const rect = menuPanel.getBoundingClientRect();
      let scale = 1;
      if (menuPos==='left' || menuPos==='right') scale = clamp(rect.width/340, 0.75, 1.4);
      else scale = clamp(rect.height/100, 0.8, 1.35);
      menuPanel.style.setProperty('--menu-font-scale', scale.toFixed(3));
    }catch(e){}
  }
  function resetMenuSizeForPosition(pos){
    menuPanel.style.width=''; menuPanel.style.height='';
    if (pos==='left' || pos==='right'){ menuPanel.style.width=DEFAULT_MENU_WIDTH+'px'; menuPanel.style.height='100vh'; }
    else { menuPanel.style.height=DEFAULT_MENU_HEIGHT+'px'; menuPanel.style.width='100vw'; }
    mainContent.style.left=''; mainContent.style.right=''; mainContent.style.top=''; mainContent.style.bottom='';
    mainContent.style.width=''; mainContent.style.height='';
  }
  function setMenuPosition(pos){
    resetMenuSizeForPosition(pos);
    menuPos=pos;
    ['left','right','top','bottom'].forEach(p=>{ menuPanel.classList.remove(p); mainContent.classList.remove(p); });
    menuPanel.classList.add(pos); mainContent.classList.add(pos);

    const mpRect = menuPanel.getBoundingClientRect();
    if (pos==='left'){
      mainContent.style.left = Math.round(mpRect.width)+'px';
      mainContent.style.top='0';
      mainContent.style.width = `calc(100vw - ${Math.round(mpRect.width)}px)`;
      mainContent.style.height='100vh';
      videoCompactRow.style.display='none'; presentationCompactRow.style.display='none';
    } else if (pos==='right'){
      mainContent.style.right = Math.round(mpRect.width)+'px';
      mainContent.style.top='0';
      mainContent.style.width = `calc(100vw - ${Math.round(mpRect.width)}px)`;
      mainContent.style.height='100vh';
      videoCompactRow.style.display='none'; presentationCompactRow.style.display='none';
    } else if (pos==='top'){
      mainContent.style.top = Math.round(mpRect.height)+'px';
      mainContent.style.left='0';
      mainContent.style.width='100vw';
      mainContent.style.height = `calc(100vh - ${Math.round(mpRect.height)}px)`;
      videoCompactRow.style.display='flex'; presentationCompactRow.style.display='flex';
    } else {
      mainContent.style.bottom = Math.round(mpRect.height)+'px';
      mainContent.style.left='0';
      mainContent.style.width='100vw';
      mainContent.style.height = `calc(100vh - ${Math.round(mpRect.height)}px)`;
      videoCompactRow.style.display='flex'; presentationCompactRow.style.display='flex';
    }
    document.querySelectorAll('.position-btn').forEach(btn=>{
      btn.classList.toggle('active', btn.dataset.position===pos);
      btn.setAttribute('aria-pressed', btn.dataset.position===pos ? 'true' : 'false');
    });
    applyMenuFontScale();
    if (pdfDoc && activeView==='presentation') renderPdfPage(currentPage);
    populateCompactSelects();
    saveState();
  }

  // Sorting logic
  function cmpNameAsc(a,b){ return displayName(a).localeCompare(displayName(b), undefined, { sensitivity:'base' }); }
  function cmpNameDesc(a,b){ return -cmpNameAsc(a,b); }
  function cmpNaturalAsc(a,b){ return naturalCompare(displayName(a), displayName(b)); }
  function cmpNaturalDesc(a,b){ return -cmpNaturalAsc(a,b); }
  function cmpAddedAsc(a,b){ return (a._addedAt||0) - (b._addedAt||0); }
  function cmpAddedDesc(a,b){ return (b._addedAt||0) - (a._addedAt||0); }

  function getComparatorFor(mode){
    switch(mode){
      case 'nameAsc': return cmpNameAsc;
      case 'nameDesc': return cmpNameDesc;
      case 'naturalAsc': return cmpNaturalAsc;
      case 'naturalDesc': return cmpNaturalDesc;
      case 'addedAsc': return cmpAddedAsc;
      case 'addedDesc': return cmpAddedDesc;
      default: return null;
    }
  }

  function applySortVideos(){
    const cmp = getComparatorFor(sortModeVideos);
    if (!cmp) return;
    const playingId = videoFiles[currentVideoIndex]?._id || null;
    videoFiles.sort(cmp);
    currentVideoIndex = playingId ? videoFiles.findIndex(v=>v._id===playingId) : -1;
  }
  function applySortPresentations(){
    const cmp = getComparatorFor(sortModePresentations);
    if (!cmp) return;
    const curId = presentationFiles[presentationIndex]?._id || null;
    presentationFiles.sort(cmp);
    presentationIndex = curId ? presentationFiles.findIndex(v=>v._id===curId) : -1;
  }

  // Icon helper
  function setUseHref(el, idWithoutHash){
    if (!el) return;
    const use = el.querySelector('use');
    if (!use) return;
    const target = (ICON_SPRITE_URL ? ICON_SPRITE_URL : '') + '#' + idWithoutHash;
    use.setAttribute('href', target);
  }

  // Loop mode UI
  function setLoopModeType(mode){
    loopModeType = mode === 'playlist' ? 'playlist' : 'single';
    videoPlayer.loop = !!loopMode && loopModeType === 'single';
    updateLoopModeBtn();
    saveState();
  }
  function updateLoopModeBtn(){
    if (!loopModeBtn) return;
    setUseHref(loopModeBtn, loopModeType === 'single' ? 'repeat-1' : 'repeat');
    loopModeBtn.title = loopModeType === 'single' ? 'Loop mode: Single video' : 'Loop mode: Playlist';
    loopModeBtn.setAttribute('aria-label', loopModeBtn.title);
    loopModeBtn.classList.toggle('active', !!loopMode);
  }
  function toggleLoopModeType(){
    if (!loopMode){ loopMode = true; updateLoopUI(); }
    const next = loopModeType === 'single' ? 'playlist' : 'single';
    setLoopModeType(next);
    showToast(next === 'single' ? 'Repeat one' : 'Repeat playlist');
  }

  // Lists rendering
  function renderVideoList(){
    videoList.innerHTML='';
    videoFiles.forEach((m,i)=>{
      ensureId(m);
      
      // NEW: Filter out videos assigned to slots in Meeting mode
      if (appMode==='meeting') {
        const isAssigned = agendaSlots.some(slot => 
          (slot.items || []).some(it => it.type==='video' && it.id===m._id)
        );
        if (isAssigned) return; // Skip assigned videos
      }
      
      const item=document.createElement('div'); item.className='file-item'; item.dataset.id=m._id; item.dataset.kind='video';
      if (activeView==='video' && i===currentVideoIndex) item.classList.add('selected');
      
      // NEW: Add checkbox in Meeting mode
      if (appMode==='meeting') {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'multi-select-checkbox';
        const key = `video:${m._id}`; // Simple string key
        checkbox.checked = multiSelectedItems.has(key);
        checkbox.addEventListener('change', (e)=> {
          e.stopPropagation();
          if (checkbox.checked) {
            multiSelectedItems.add(key);
            item.classList.add('multi-selected');
          } else {
            multiSelectedItems.delete(key);
            item.classList.remove('multi-selected');
          }
          updateMultiSelectUI();
        });
        checkbox.addEventListener('click', e=> e.stopPropagation());
        item.appendChild(checkbox);
        if (checkbox.checked) item.classList.add('multi-selected');
      }
      
      const name=document.createElement('div'); name.className='file-item-name'; name.textContent=displayName(m); item.appendChild(name);
      // FEATURE 1: Add duration display
      if (m._duration) {
        const duration=document.createElement('div'); duration.className='file-item-duration';
        duration.textContent=formatDuration(m._duration); item.appendChild(duration);
      }
      
      // Click handler - don't play if checkbox exists in Meeting mode
      const shouldPlay = () => appMode!=='meeting' || !item.querySelector('.multi-select-checkbox');
      item.addEventListener('click',()=> { if (shouldPlay()) playVideo(i); });
      // Drag out to agenda slot
      item.draggable=true;
      item.addEventListener('dragstart',e=>{
        item.classList.add('dragging');
        e.dataTransfer.effectAllowed='copy';
        e.dataTransfer.setData('application/x-smo-media', JSON.stringify({ kind:'video', id:m._id }));
      });
      item.addEventListener('dragend',()=> item.classList.remove('dragging'));
      videoList.appendChild(item);
    });
    document.getElementById('videoHelperText').style.display = videoFiles.length? 'none':'block';
    populateCompactSelects();
    updateNavBackBtn();
  }
  function renderPresentationList(){
    presentationList.innerHTML='';
    presentationFiles.forEach((m,i)=>{
      ensureId(m);
      
      // NEW: Filter out presentations assigned to slots in Meeting mode
      if (appMode==='meeting') {
        const isAssigned = agendaSlots.some(slot => 
          (slot.items || []).some(it => it.type==='pdf' && it.id===m._id)
        );
        if (isAssigned) return; // Skip assigned presentations
      }
      
      const item=document.createElement('div'); item.className='file-item'; item.dataset.id=m._id; item.dataset.kind='pdf';
      if (activeView==='presentation' && i===presentationIndex) item.classList.add('selected');
      
      // NEW: Add checkbox in Meeting mode
      if (appMode==='meeting') {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'multi-select-checkbox';
        const key = `pdf:${m._id}`; // Simple string key
        checkbox.checked = multiSelectedItems.has(key);
        checkbox.addEventListener('change', (e)=> {
          e.stopPropagation();
          if (checkbox.checked) {
            multiSelectedItems.add(key);
            item.classList.add('multi-selected');
          } else {
            multiSelectedItems.delete(key);
            item.classList.remove('multi-selected');
          }
          updateMultiSelectUI();
        });
        checkbox.addEventListener('click', e=> e.stopPropagation());
        item.appendChild(checkbox);
        if (checkbox.checked) item.classList.add('multi-selected');
      }
      
      const name=document.createElement('div'); name.className='file-item-name'; name.textContent=displayName(m); item.appendChild(name);
      
      // Click handler - don't load if checkbox exists in Meeting mode
      const shouldLoad = () => appMode!=='meeting' || !item.querySelector('.multi-select-checkbox');
      item.addEventListener('click',()=> { if (shouldLoad()) loadPresentation(i); });
      // Drag out to agenda slot
      item.draggable=true;
      item.addEventListener('dragstart',e=>{
        item.classList.add('dragging');
        e.dataTransfer.effectAllowed='copy';
        e.dataTransfer.setData('application/x-smo-media', JSON.stringify({ kind:'pdf', id:m._id }));
      });
      item.addEventListener('dragend',()=> item.classList.remove('dragging'));
      presentationList.appendChild(item);
    });
    document.getElementById('presentationHelperText').style.display = presentationFiles.length? 'none':'block';
    populateCompactSelects();
    updateNavBackBtn();
  }

  // NEW: Multi-select UI functions
  function updateMultiSelectUI() {
    const hasSelection = multiSelectedItems.size > 0;
    if (multiSelectToolbar) {
      multiSelectToolbar.style.display = (appMode==='meeting' && hasSelection) ? 'block' : 'none';
    }
    // Update slot assignment dropdown
    if (slotAssignDropdown && appMode==='meeting') {
      populateSlotDropdown();
    }
  }

  function populateSlotDropdown() {
    if (!slotAssignDropdown) return;
    slotAssignDropdown.innerHTML = '<option value="">Select slot...</option>';
    agendaSlots.forEach((slot, idx) => {
      const option = document.createElement('option');
      option.value = slot.id;
      option.textContent = `${idx + 1}. ${slot.title || '(Untitled)'} - ${slot.start || '--:--'}`;
      slotAssignDropdown.appendChild(option);
    });
  }

  function assignSelectedToSlot(slotId) {
    const slot = agendaSlots.find(s => s.id === slotId);
    if (!slot) return;
    
    if (!slot.items) slot.items = [];
    
    let addedCount = 0;
    multiSelectedItems.forEach(itemKey => {
      // Parse simple string key format "type:id"
      const [type, id] = itemKey.split(':');
      if (type && id) {
        const item = { type, id };
        // Check if already in slot
        const exists = slot.items.some(it => it.type===item.type && it.id===item.id);
        if (!exists) {
          slot.items.push(item);
          addedCount++;
        }
      }
    });
    
    // Clear selection
    multiSelectedItems.clear();
    
    // Re-render
    renderVideoList();
    renderPresentationList();
    renderAgendaPanel();
    updateMultiSelectUI();
    saveState();
    
    if (addedCount > 0) {
      showToast(`${addedCount} item(s) assigned to slot`);
    }
  }

  function getDragAfterElement(container,y){
    const draggable=[...container.querySelectorAll('.file-item:not(.dragging), .mini-item:not(.dragging)')];
    return draggable.reduce((closest,child)=>{ const box=child.getBoundingClientRect(); const offset = y - box.top - box.height/2; if(offset<0 && offset>closest.offset) return {offset,element:child}; return closest; },{offset:Number.NEGATIVE_INFINITY}).element;
  }

  // Modal lists
  function renderModalVideoList(){
    modalVideoList.innerHTML='';
    videoFiles.forEach((m,i)=>{
      const row=document.createElement('div'); row.className='mini-item'; row.draggable=true; row.dataset.id=m._id;
      const name=document.createElement('span'); name.className='item-name'; name.contentEditable=true; name.textContent=m._customName || m.file.name;
      name.addEventListener('blur',()=>{ const v=name.textContent.trim(); if(v) m._customName=v; else name.textContent=m._customName||m.file.name; renderVideoList(); saveState(); });
      name.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); name.blur(); }});
      name.addEventListener('mousedown',e=> e.stopPropagation());
      const rm=document.createElement('span'); rm.className='mini-remove'; rm.textContent='✕'; rm.setAttribute('aria-label','Remove video');
      rm.addEventListener('click',()=> removeVideo(i));
      row.appendChild(name); row.appendChild(rm);

      row.addEventListener('dragstart',()=> row.classList.add('dragging'));
      row.addEventListener('dragover',e=>{ e.preventDefault(); const dragging=modalVideoList.querySelector('.mini-item.dragging'); if(!dragging) return; const after=getModalDragAfterElement(modalVideoList,e.clientY); if(after==null) modalVideoList.appendChild(dragging); else modalVideoList.insertBefore(dragging,after); });
      row.addEventListener('dragend',()=>{ row.classList.remove('dragging'); const nodes=[...modalVideoList.children]; const newOrder = nodes.map(n=> videoFiles.find(m=>m._id===n.dataset.id)).filter(Boolean); if(newOrder.length===videoFiles.length){ const playingId = videoFiles[currentVideoIndex] && videoFiles[currentVideoIndex]._id; videoFiles=newOrder; currentVideoIndex = playingId ? videoFiles.findIndex(m=>m._id===playingId) : -1; } renderVideoList(); renderModalVideoList(); saveState(); });
      modalVideoList.appendChild(row);
    });
  }
  function renderModalPresentationList(){
    modalPresentationList.innerHTML='';
    presentationFiles.forEach((m,i)=>{
      const row=document.createElement('div'); row.className='mini-item'; row.draggable=true; row.dataset.id=m._id;
      const name=document.createElement('span'); name.className='item-name'; name.contentEditable=true; name.textContent=m._customName || m.file.name;
      name.addEventListener('blur',()=>{ const v=name.textContent.trim(); if(v) m._customName=v; else name.textContent=m._customName||m.file.name; renderPresentationList(); saveState(); });
      name.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); name.blur(); }});
      name.addEventListener('mousedown',e=> e.stopPropagation());
      const rm=document.createElement('span'); rm.className='mini-remove'; rm.textContent='✕'; rm.setAttribute('aria-label','Remove presentation');
      rm.addEventListener('click',()=> removePresentation(i));
      row.appendChild(name); row.appendChild(rm);

      row.addEventListener('dragstart',()=> row.classList.add('dragging'));
      row.addEventListener('dragover',e=>{ e.preventDefault(); const dragging=modalPresentationList.querySelector('.mini-item.dragging'); if(!dragging) return; const after=getModalDragAfterElement(modalPresentationList,e.clientY); if(after==null) modalPresentationList.appendChild(dragging); else modalPresentationList.insertBefore(dragging,after); });
      row.addEventListener('dragend',()=>{ row.classList.remove('dragging'); const nodes=[...modalPresentationList.children]; const newOrder = nodes.map(n=> presentationFiles.find(m=>m._id===n.dataset.id)).filter(Boolean); if(newOrder.length===presentationFiles.length){ const curId = presentationFiles[presentationIndex] && presentationFiles[presentationIndex]._id; presentationFiles=newOrder; presentationIndex = curId ? presentationFiles.findIndex(m=>m._id===curId) : -1; } renderPresentationList(); renderModalPresentationList(); saveState(); });
      modalPresentationList.appendChild(row);
    });
  }
  function getModalDragAfterElement(container,y){
    const draggable=[...container.querySelectorAll('.mini-item:not(.dragging)')];
    return draggable.reduce((closest,child)=>{ const box=child.getBoundingClientRect(); const offset = y - box.top - box.height/2; if(offset<0 && offset>closest.offset) return {offset,element:child}; return closest; },{offset:Number.NEGATIVE_INFINITY}).element;
  }

  // Video playback
  function playVideo(index){
    if (presentationIndex>=0 && pdfDoc){
      const prev=presentationFiles[presentationIndex]; if(prev) prev._currentPage=currentPage;
    }
    activeView='video';
    currentVideoIndex = index;

    const meta = videoFiles[index];
    if (!meta){
      videoContainer.style.display='none'; emptyState.style.display='flex';
      renderVideoList(); renderPresentationList(); populateCompactSelects(); updateNavBackBtn(); return;
    }

    if (currentVideoUrl) { try{ URL.revokeObjectURL(currentVideoUrl); }catch(_){} }
    currentVideoUrl = URL.createObjectURL(meta.file);
    videoPlayer.src = currentVideoUrl;
    videoPlayer.loop = !!loopMode && loopModeType === 'single';

    videoContainer.style.display='flex'; presentationContainer.style.display='none'; emptyState.style.display='none';
    videoPlayer.play().catch(()=>{});

    renderVideoList(); renderPresentationList(); populateCompactSelects(); updateNavBackBtn(); saveState();
  }
  function stopVideo(){ try{ videoPlayer.pause(); }catch(_){} }
  function playNextInPlaylist(){
    if (!videoFiles.length) return;
    if (currentVideoIndex === -1) { currentVideoIndex = 0; }
    let next = currentVideoIndex + 1;
    if (next >= videoFiles.length) next = 0;
    playVideo(next);
  }
  function removeVideo(index){
    const wasPlaying = (index===currentVideoIndex && activeView==='video');
    videoFiles.splice(index,1);
    if (videoFiles.length===0){
      stopVideo();
      if (currentVideoUrl) try{ URL.revokeObjectURL(currentVideoUrl); }catch(_){}
      videoPlayer.removeAttribute('src'); videoContainer.style.display='none'; emptyState.style.display='flex'; currentVideoIndex=-1; if (wasPlaying) activeView=null;
    } else {
      if (wasPlaying){ currentVideoIndex=Math.min(index, videoFiles.length-1); renderVideoList(); }
      else { if (index<currentVideoIndex) currentVideoIndex--; renderVideoList(); }
    }
    renderModalVideoList(); populateCompactSelects(); updateNavBackBtn(); saveState();
  }

  // PDF open
  async function loadPresentation(index){
    stopVideo();

    if (presentationIndex>=0 && pdfDoc){
      const prev=presentationFiles[presentationIndex]; if(prev) prev._currentPage=currentPage;
    }
    presentationIndex=index; activeView='presentation';

    const meta = presentationFiles[index];
    if (!meta){
      pdfDoc=null; pdfCtx.clearRect(0,0,pdfCanvas.width,pdfCanvas.height); pageInfo.textContent='';
      presentationContainer.style.display='none'; emptyState.style.display='flex';
      renderPresentationList(); renderVideoList(); populateCompactSelects(); updateNavBackBtn(); return;
    }

    const myToken = ++pdfLoadToken;
    try {
      if (!meta._arrayBuffer) meta._arrayBuffer = await readFileAsArrayBuffer(meta.file);
      if (pdfLoadToken !== myToken) return;
      const typed = toUint8Array(meta._arrayBuffer);
      const doc1 = await openPdf({ data: typed });
      if (pdfLoadToken !== myToken) return;
      pdfDoc = doc1;
    } catch (e1) {
      try {
        if (pdfLoadToken !== myToken) return;
        const blobUrl = URL.createObjectURL(meta.file);
        const doc2 = await openPdf({ url: blobUrl, withCredentials: false, disableRange: true, disableAutoFetch: true });
        if (pdfLoadToken !== myToken) return;
        pdfDoc = doc2;
      } catch (e2) {
        console.error('PDF open failed', e1, e2);
        alert('Unable to open this PDF. Please verify the file is valid.');
        return;
      }
    }

    currentPage = (typeof meta._currentPage==='number' && meta._currentPage>=1 && meta._currentPage<=pdfDoc.numPages) ? meta._currentPage : 1;
    presentationContainer.style.display='flex'; videoContainer.style.display='none'; emptyState.style.display='none';
    renderPresentationList(); renderVideoList(); populateCompactSelects(); updateNavBackBtn(); saveState();
    renderPdfPage(currentPage);
  }
  function updateNavBackBtn() {
    const shouldShow = (activeView === 'video' && presentationFiles.length > 0) || 
                       (activeView === 'presentation' && videoFiles.length > 0);
    if (shouldShow) {
      navBackBtn.classList.add('show');
      navBackBtn.title = activeView === 'video' ? 'Switch to Presentation' : 'Switch to Video';
    } else {
      navBackBtn.classList.remove('show');
    }
  }

  function openPdf(opts){
    return new Promise((resolve, reject) => {
      try { const task = pdfjsLib.getDocument(opts); task.promise.then(resolve).catch(reject); }
      catch (err) { reject(err); }
    });
  }
  function toUint8Array(buf){
    if (buf instanceof ArrayBuffer) return new Uint8Array(buf);
    if (ArrayBuffer.isView(buf)) return new Uint8Array(buf.buffer);
    return new Uint8Array(buf);
  }
  function readFileAsArrayBuffer(file){
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = () => reject(r.error || new Error('File read error'));
      r.readAsArrayBuffer(file);
    });
  }

  function renderPdfPage(pageNum){
    if (!pdfDoc) return;
    pdfDoc.getPage(pageNum).then(page=>{
      // Get presentation container and calculate available space
      const presContainer = presentationContainer.getBoundingClientRect();
      const controlsHeight = 60; // Height of controls bar
      const containerW = presContainer.width;
      const containerH = presContainer.height - controlsHeight;
      
      // Get PDF page's natural aspect ratio
      const unscaled = page.getViewport({ scale: 1 });
      const pdfAspect = unscaled.width / unscaled.height;
      const containerAspect = containerW / containerH;
      
      // Calculate optimal scale to maximize use of screen while maintaining aspect ratio
      let scale;
      if (pdfAspect > containerAspect) {
        // PDF is wider than container - fit to width
        scale = containerW / unscaled.width;
      } else {
        // PDF is taller than container - fit to height
        scale = containerH / unscaled.height;
      }
      
      // Apply high-quality rendering with device pixel ratio
      const deviceScale = window.devicePixelRatio || 1;
      // Scale for crisp rendering on high-DPI displays
      const renderScale = scale * deviceScale;
      
      const vp = page.getViewport({ scale: renderScale });

      // Set canvas internal resolution (high for crisp rendering)
      pdfCanvas.width = Math.round(vp.width);
      pdfCanvas.height = Math.round(vp.height);
      
      // Set canvas display size (actual size on screen)
      pdfCanvas.style.width = (vp.width / deviceScale) + 'px';
      pdfCanvas.style.height = (vp.height / deviceScale) + 'px';

      return page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport: vp }).promise
        .then(()=> { 
          pageInfo.textContent = `Page ${pageNum} of ${pdfDoc.numPages}`;
          // Update button states
          prevPageBtn.disabled = (pageNum <= 1);
          nextPageBtn.disabled = (pageNum >= pdfDoc.numPages);
        });
    }).catch(err=> console.error('renderPdfPage error', err));
  }

  function removePresentation(index){
    const wasActive = (index===presentationIndex && activeView==='presentation');
    presentationFiles.splice(index,1);
    if (presentationFiles.length===0){
      pdfDoc=null; pdfCtx.clearRect(0,0,pdfCanvas.width,pdfCanvas.height); pageInfo.textContent='';
      presentationContainer.style.display='none'; emptyState.style.display='flex'; presentationIndex=-1; if (wasActive) activeView=null;
    } else {
      if (wasActive){ const newIdx=Math.min(index, presentationFiles.length-1); loadPresentation(newIdx); }
      else { if (index<presentationIndex) presentationIndex--; renderPresentationList(); }
    }
    renderModalPresentationList(); populateCompactSelects(); updateNavBackBtn(); saveState();
  }

  // Compact selects
  function populateCompactSelects(){
    videoSelectCompact.innerHTML=''; presentationSelectCompact.innerHTML='';
    if (!videoFiles.length){ const o=document.createElement('option'); o.value='-1'; o.textContent='—'; videoSelectCompact.appendChild(o); videoSelectCompact.disabled=true; }
    else { videoFiles.forEach((m,i)=>{ const o=document.createElement('option'); o.value=String(i); o.textContent=displayName(m); videoSelectCompact.appendChild(o); }); videoSelectCompact.disabled=false; videoSelectCompact.value=String(Math.max(0,currentVideoIndex)); }
    if (!presentationFiles.length){ const o=document.createElement('option'); o.value='-1'; o.textContent='—'; presentationSelectCompact.appendChild(o); presentationSelectCompact.disabled=true; }
    else { presentationFiles.forEach((m,i)=>{ const o=document.createElement('option'); o.value=String(i); o.textContent=displayName(m); presentationSelectCompact.appendChild(o); }); presentationSelectCompact.disabled=false; presentationSelectCompact.value=String(Math.max(0,presentationIndex)); }
    
    // NEW: Populate combined dropdown for top/bottom menu
    if (combinedMediaSelect) {
      combinedMediaSelect.innerHTML = '<option value="">Select media...</option>';
      if (videoFiles.length) {
        const vidGroup = document.createElement('optgroup');
        vidGroup.label = 'Videos';
        videoFiles.forEach((m,i)=>{
          const o=document.createElement('option'); 
          o.value=`video:${i}`; 
          o.textContent=displayName(m); 
          vidGroup.appendChild(o);
        });
        combinedMediaSelect.appendChild(vidGroup);
      }
      if (presentationFiles.length) {
        const presGroup = document.createElement('optgroup');
        presGroup.label = 'Presentations';
        presentationFiles.forEach((m,i)=>{
          const o=document.createElement('option'); 
          o.value=`pdf:${i}`; 
          o.textContent=displayName(m); 
          presGroup.appendChild(o);
        });
        combinedMediaSelect.appendChild(presGroup);
      }
      combinedMediaSelect.disabled = !videoFiles.length && !presentationFiles.length;
      // Set current selection
      if (activeView==='video' && currentVideoIndex>=0) {
        combinedMediaSelect.value = `video:${currentVideoIndex}`;
      } else if (activeView==='presentation' && presentationIndex>=0) {
        combinedMediaSelect.value = `pdf:${presentationIndex}`;
      }
    }
  }

  // Add files — NO auto-play
  async function handleVideoAdd(files){
    const savedMap=buildSavedMap();
    const now = Date.now();
    const metas= await Promise.all([...files].filter(f=>f.type.startsWith('video/')).map(async f=>{
      const sm=savedMap[f.name];
      // FEATURE 1: Extract duration
      const duration = await getVideoDuration(f);
      return {file:f,_id:makeId(), _customName: sm? sm._customName || null : null, _addedAt: (sm && sm._addedAt) || now, _duration: duration};
    }));
    if (!metas.length) return;
    videoFiles.push(...metas);
    if (sortModeVideos!=='custom') applySortVideos();
    renderVideoList();
    renderModalVideoList();
    saveState();
    markOnboarded();
    showToast(`${metas.length} video${metas.length>1?'s':''} imported`);
  }
  function handlePresentationAdd(files){
    const savedMap=buildSavedMap();
    const now = Date.now();
    const metas=[...files].filter(f=>f.name.toLowerCase().endsWith('.pdf')).map(f=>{
      const sm=savedMap[f.name];
      return {file:f,_id:makeId(), _customName: sm? sm._customName || null : null, _currentPage: sm? sm._currentPage || 1 : 1, _addedAt: (sm && sm._addedAt) || now};
    });
    if (!metas.length) return;
    presentationFiles.push(...metas);
    if (sortModePresentations!=='custom') applySortPresentations();
    renderPresentationList();
    renderModalPresentationList();
    saveState();
    markOnboarded();
    showToast(`${metas.length} presentation${metas.length>1?'s':''} imported`);
  }

  // Loop UI (Settings)
  function updateLoopUI(){
    loopSwitch.style.background = loopMode ? 'var(--se-life-green)' : 'var(--border)';
    loopSwitchKnob.style.left = loopMode ? '19px' : '3px';
    loopToggle.setAttribute('aria-pressed', loopMode ? 'true' : 'false');
    loopLabel.textContent = 'Loop: ' + (loopMode ? 'On' : 'Off');
    videoPlayer.loop = !!loopMode && (loopModeType === 'single');
    loopModeBtn.classList.toggle('active', !!loopMode);
  }

  // Fullscreen helpers
  function isFullscreen(){
    return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
  }
  async function toggleFullscreen(){
    try{
      if (!isFullscreen()){
        const el = document.documentElement;
        if (el.requestFullscreen) await el.requestFullscreen();
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        else if (el.msRequestFullscreen) el.msRequestFullscreen();
      } else {
        if (document.exitFullscreen) await document.exitFullscreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        else if (document.msExitFullscreen) document.msExitFullscreen();
      }
    }catch(e){ console.error('Fullscreen toggle error', e); }
    updateFullscreenUI();
  }
  function updateFullscreenUI(){
    const enabled = document.fullscreenEnabled || document.webkitFullscreenEnabled || document.msFullscreenEnabled;
    fullscreenBtns.forEach(btn=>{
      btn.disabled = !enabled;
      btn.title = isFullscreen() ? 'Exit Fullscreen' : 'Enter Fullscreen';
      setUseHref(btn, isFullscreen() ? 'minimize' : 'maximize');
    });
    setMenuPosition(menuPos);
    if (pdfDoc && activeView==='presentation') renderPdfPage(currentPage);
  }

  // Settings + onboarding
  function showSettings(){
    if (timeZoneSelect) timeZoneSelect.value = timeZone;
    modalOverlay.classList.add('show');
    renderModalVideoList();
    renderModalPresentationList();
    refreshModeControls();
    renderAgendaRows();
    updateLoopUI();
  }
  function markOnboarded(){ try { localStorage.setItem(ONBOARDED_KEY, '1'); } catch(e){} }

  // Mode handling
  function refreshModeControls(){
    if (modePresentation) modePresentation.checked = (appMode==='presentation');
    if (modeMeeting) modeMeeting.checked = (appMode==='meeting');
    const disablePositions = (appMode==='meeting');
    positionButtonsWrap.querySelectorAll('button').forEach(b=>{
      b.disabled = disablePositions;
      b.title = disablePositions ? 'Menu position is fixed to Left in Meeting mode' : (b.getAttribute('data-title') || b.title || '');
      b.style.opacity = disablePositions ? 0.5 : 1;
    });
    positionHelper.textContent = (appMode==='meeting')
      ? 'Menu position is fixed to Left in Meeting mode.'
      : 'Use these buttons to change menu position.';
    agendaSection.style.display = (appMode==='meeting') ? 'block' : 'none';
  }
  function setAppMode(mode){
    appMode = (mode==='meeting') ? 'meeting' : 'presentation';
    if (appMode==='meeting'){
      if (menuPos!=='left'){ setMenuPosition('left'); }
    }
    // Clear multi-select when switching modes
    multiSelectedItems.clear();
    refreshModeControls();
    renderAgendaPanel();
    renderVideoList();
    renderPresentationList();
    updateMultiSelectUI();
    saveState();
  }

  // Agenda in Settings
  function ensureEndAfterStart(slot){
    const s = parseHHMM(slot.start);
    let e = parseHHMM(slot.end);
    if (s==null) return;
    if (e==null || e <= s){ e = s + MIN_SLOT_MINUTES; slot.end = fmtHHMM(e); }
  }
  function rechainStarts(fromIndex=1){
    for (let i=Math.max(1, fromIndex); i<agendaSlots.length; i++){
      const prevEnd = parseHHMM(agendaSlots[i-1].end);
      if (prevEnd!=null){
        agendaSlots[i].start = fmtHHMM(prevEnd);
        ensureEndAfterStart(agendaSlots[i]);
      }
    }
  }
  function renderAgendaRows(){
    agendaRows.innerHTML = '';
    agendaSlots.forEach((slot, idx)=>{
      const row = document.createElement('div'); row.className='agenda-row'; row.dataset.id = slot.id; row.draggable=true;

      const grip = document.createElement('div'); grip.className='grip'; grip.textContent='⋮⋮';

      const titleWrap = document.createElement('div'); titleWrap.style.display='flex'; titleWrap.style.flexDirection='column'; titleWrap.style.gap='4px';
      const title = document.createElement('input'); title.type='text'; title.value = slot.title || ''; title.placeholder='Title';
      title.addEventListener('input', ()=>{ slot.title = title.value.trim(); renderAgendaPanel(); saveState(); });
      titleWrap.appendChild(title);
      
      // FEATURE 5: Subtitle input
      const subtitle = document.createElement('input'); subtitle.type='text'; subtitle.className='subtitle-input';
      subtitle.value = slot.subtitle || ''; subtitle.placeholder='Subtitle (optional)';
      subtitle.addEventListener('input', ()=>{ slot.subtitle = subtitle.value.trim(); renderAgendaPanel(); saveState(); });
      titleWrap.appendChild(subtitle);

      // FEATURE 3: Text inputs for time to allow slower typing (e.g., "07" without rushing)
      const start = document.createElement('input'); start.type='text'; start.value = slot.start || ''; 
      start.placeholder='HH:MM'; start.pattern='[0-2][0-9]:[0-5][0-9]'; start.maxLength='5';
      const end = document.createElement('input'); end.type='text'; end.value = slot.end || '';
      end.placeholder='HH:MM'; end.pattern='[0-2][0-9]:[0-5][0-9]'; end.maxLength='5';

      // FEATURE 4: Duration input with better number handling
      const duration = document.createElement('input'); duration.type='text'; duration.inputMode='numeric'; 
      duration.pattern='[0-9]+'; duration.maxLength='4';
      const startMins = parseHHMM(slot.start);
      const endMins = parseHHMM(slot.end);
      if (startMins !== null && endMins !== null) {
        duration.value = endMins - startMins;
      }
      duration.placeholder='mins';
      
      // Better input handling: update on blur (after user finishes typing)
      duration.addEventListener('blur', ()=>{
        const dur = parseInt(duration.value, 10);
        if (!isNaN(dur) && dur >= 5) {
          const s = parseHHMM(slot.start);
          if (s !== null) {
            slot.end = fmtHHMM(s + dur);
            rechainStarts(idx+1);
            renderAgendaRows();
            renderAgendaPanel();
            saveState();
          }
        } else if (duration.value.trim() !== '') {
          // Reset to current duration if invalid
          const s = parseHHMM(slot.start);
          const e = parseHHMM(slot.end);
          if (s !== null && e !== null) {
            duration.value = e - s;
          }
        }
      });

      // Only first slot start editable
      start.disabled = (idx !== 0);

      // Validate and format time inputs on blur
      start.addEventListener('blur', ()=>{
        const val = start.value.trim();
        if (val && parseHHMM(val) !== null) {
          slot.start = val;
          ensureEndAfterStart(slot);
          // re-chain all subsequent
          rechainStarts(1);
          renderAgendaRows();
          renderAgendaPanel();
          saveState();
        } else if (val !== '') {
          // Reset to current value if invalid
          start.value = slot.start || '';
        }
      });
      end.addEventListener('blur', ()=>{
        const val = end.value.trim();
        if (val && parseHHMM(val) !== null) {
          slot.end = val;
          ensureEndAfterStart(slot);
          // next slot start becomes this end
          rechainStarts(idx+1);
          renderAgendaRows();
          renderAgendaPanel();
          saveState();
        } else if (val !== '') {
          // Reset to current value if invalid
          end.value = slot.end || '';
        }
      });

      const del = document.createElement('button'); del.type='button'; del.className='del-slot'; del.title='Remove slot'; del.textContent='✕';
      del.addEventListener('click', ()=>{
        agendaSlots.splice(idx,1);
        rechainStarts(1);
        renderAgendaRows();
        renderAgendaPanel();
        saveState();
      });

      // Drag reorder: moved slot inherits the time of its new index (slot # position)
      row.addEventListener('dragstart', ()=> row.classList.add('dragging'));
      row.addEventListener('dragover', (e)=>{
        e.preventDefault();
        const dragging = agendaRows.querySelector('.agenda-row.dragging');
        if (!dragging) return;
        const after = getAgendaRowAfter(agendaRows, e.clientY);
        if (after==null) agendaRows.appendChild(dragging);
        else agendaRows.insertBefore(dragging, after);
      });
      row.addEventListener('dragend', ()=>{
        row.classList.remove('dragging');
        // Capture current time pairs by index
        const timesByIndex = agendaSlots.map(s=> ({ start:s.start, end:s.end }));
        // Build new order by DOM
        const newOrder = [...agendaRows.querySelectorAll('.agenda-row')].map(n => agendaSlots.find(s=>s.id===n.dataset.id)).filter(Boolean);
        if (newOrder.length === agendaSlots.length){
          // Assign times by index: position defines time (slot moved to #2 takes old #2 times)
          newOrder.forEach((s,i)=>{
            s.start = timesByIndex[i]?.start || s.start;
            s.end   = timesByIndex[i]?.end   || s.end;
            ensureEndAfterStart(s);
          });
          agendaSlots = newOrder;
          // After reassigning, rechain from index 1 to ensure continuity if desired (keep exact assigned schedule)
          // We will NOT override slot[1] time; chaining starts from the slot after the one you edit at runtime.
        }
        renderAgendaRows();
        renderAgendaPanel();
        saveState();
      });

      row.appendChild(grip);
      row.appendChild(titleWrap);
      row.appendChild(start);
      row.appendChild(end);
      row.appendChild(duration);
      row.appendChild(del);
      agendaRows.appendChild(row);
    });
  }
  function getAgendaRowAfter(container,y){
    const rows=[...container.querySelectorAll('.agenda-row:not(.dragging)')];
    return rows.reduce((closest,child)=>{
      const box=child.getBoundingClientRect();
      const offset=y - box.top - box.height/2;
      if(offset<0 && offset>closest.offset) return {offset,element:child};
      return closest;
    },{offset:Number.NEGATIVE_INFINITY}).element;
  }

  function addAgendaSlotWithDuration(minutes){
    const dur = Math.max(MIN_SLOT_MINUTES, minutes|0);
    let startMins;
    if (agendaSlots.length === 0){
      startMins = roundDownTo5(getNowTZMinutes());
    } else {
      const last = agendaSlots[agendaSlots.length-1];
      const lastEndM = parseHHMM(last.end);
      startMins = (lastEndM!=null) ? lastEndM : roundDownTo5(getNowTZMinutes());
    }
    const endMins = startMins + dur;
    agendaSlots.push({ id: makeId(), title:'', start: fmtHHMM(startMins), end: fmtHHMM(endMins), items:[] });
    // Ensure chaining integrity
    rechainStarts(1);
    renderAgendaRows();
    renderAgendaPanel();
    saveState();
  }

  // Agenda in Menu (Meeting)
  function renderAgendaPanel(){
    if (appMode!=='meeting'){ agendaPanel.innerHTML=''; return; }
    agendaPanel.innerHTML = '';
    const nowMins = getNowTZMinutes();

    agendaSlots.forEach((slot)=>{
      const sStart = parseHHMM(slot.start);
      const sEnd = parseHHMM(slot.end);
      const active = (sStart!=null && sEnd!=null && nowMins>=sStart && nowMins<=sEnd);

      const card = document.createElement('div'); 
      card.className='agenda-slot' + (active?' active':'');
      if (slot.completed) card.classList.add('completed');
      card.dataset.id = slot.id;

      const header = document.createElement('div'); header.className='slot-header';
      
      // FEATURE: Checkbox to mark slot as completed
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'slot-checkbox';
      checkbox.checked = slot.completed || false;
      checkbox.addEventListener('change', (e)=>{
        slot.completed = e.target.checked;
        if (slot.completed) {
          card.classList.add('completed');
        } else {
          card.classList.remove('completed');
        }
        saveState();
      });
      
      const titleWrap = document.createElement('div'); titleWrap.style.display='flex'; titleWrap.style.flexDirection='column'; titleWrap.style.width='100%';
      const title = document.createElement('div'); title.className='slot-title'; title.textContent = slot.title || '(Untitled)';
      titleWrap.appendChild(title);
      // FEATURE 5: Display subtitle
      if (slot.subtitle) {
        const subtitle = document.createElement('div'); subtitle.className='slot-subtitle'; subtitle.textContent = slot.subtitle;
        titleWrap.appendChild(subtitle);
      }
      const right = document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
      if (active){ const badge=document.createElement('span'); badge.className='slot-badge'; badge.textContent='NOW'; right.appendChild(badge); }
      const time = document.createElement('div'); time.className='slot-time'; time.textContent = (slot.start||'--:--') + ' – ' + (slot.end||'--:--');
      right.appendChild(time);
      header.appendChild(checkbox); header.appendChild(titleWrap); header.appendChild(right);
      card.appendChild(header);

      // Individual progress bars removed - using overall progress bar instead
      // See overall progress bar added after the forEach loop

      // Items list
      const itemsWrap = document.createElement('div'); itemsWrap.className='slot-items';
      itemsWrap.addEventListener('dragover', (e)=>{ e.preventDefault(); itemsWrap.classList.add('drag-over'); });
      itemsWrap.addEventListener('dragleave', ()=> itemsWrap.classList.remove('drag-over'));
      itemsWrap.addEventListener('drop', (e)=>{
        e.preventDefault(); itemsWrap.classList.remove('drag-over');
        try{
          const raw = e.dataTransfer.getData('application/x-smo-media');
          if (!raw) return;
          const data = JSON.parse(raw);
          if (!data || !data.kind || !data.id) return;
          if (!slot.items) slot.items=[];
          const exists = slot.items.some(it=> it.id===data.id && it.type===data.kind);
          if (!exists){
            slot.items.push({ id:data.id, type:data.kind });
            renderAgendaPanel(); saveState();
          }
        }catch(err){}
      });

      (slot.items||[]).forEach((it, idx)=>{
        const itemRow = document.createElement('div'); itemRow.className='slot-item';
        // FEATURE: Highlight if this media is currently playing
        const isActive = (it.type==='video' && activeView==='video' && videoFiles[currentVideoIndex]?._id===it.id) || (it.type==='pdf' && activeView==='presentation' && presentationFiles[presentationIndex]?._id===it.id);
        if (isActive) itemRow.classList.add('active-media'); itemRow.draggable=true; itemRow.dataset.index=idx;

        const nameSpan = document.createElement('span'); nameSpan.className='si-name';
        const typeSpan = document.createElement('span'); typeSpan.className='si-type';
        
        // Resolve name and type from libraries or custom data
        let openHandler = null;
        if (it.type==='video'){
          typeSpan.textContent = 'Video';
          const meta = videoFiles.find(v=> v._id===it.id);
          nameSpan.textContent = meta ? (meta._customName || baseName(meta.file.name)) : '(missing video)';
          openHandler = ()=> {
            const vi = videoFiles.findIndex(v=> v._id===it.id);
            if (vi>=0) playVideo(vi);
          };
        } else if (it.type==='pdf'){
          typeSpan.textContent = 'PDF';
          const meta = presentationFiles.find(p=> p._id===it.id);
          nameSpan.textContent = meta ? (meta._customName || baseName(meta.file.name)) : '(missing PDF)';
          openHandler = ()=> {
            const pi = presentationFiles.findIndex(p=> p._id===it.id);
            if (pi>=0) loadPresentation(pi);
          };
        } else if (it.type==='text'){
          typeSpan.textContent = 'TEXT';
          typeSpan.style.background = '#3b82f6';
          nameSpan.textContent = it.data.content.substring(0, 50) + (it.data.content.length > 50 ? '...' : '');
          openHandler = ()=> alert(`Text: ${it.data.content}`);
        } else if (it.type==='link'){
          typeSpan.textContent = 'LINK';
          typeSpan.style.background = '#f97316';
          nameSpan.textContent = it.data.name;
          openHandler = ()=> window.open(it.data.url, '_blank');
        } else if (it.type==='photo'){
          typeSpan.textContent = 'PHOTO';
          typeSpan.style.background = '#a855f7';
          nameSpan.textContent = it.data.name;
          // Add thumbnail if available
          if (it.data.url) {
            const img = document.createElement('img');
            img.src = it.data.url;
            img.className = 'photo-thumbnail';
            itemRow.insertBefore(img, nameSpan);
          }
          openHandler = ()=> {
            if (it.data.url) window.open(it.data.url, '_blank');
          };
        }

        // Open on row/name click
        itemRow.addEventListener('click', (e)=>{
          if (e.target && e.target.classList && e.target.classList.contains('si-x')) return;
          if (openHandler) openHandler();
        });
        nameSpan.addEventListener('click', (e)=>{ e.stopPropagation(); if (openHandler) openHandler(); });

        // Small X remove button
        const btnX = document.createElement('button'); btnX.className='si-x'; btnX.title='Remove'; btnX.textContent='×';
        btnX.addEventListener('click', (e)=>{
          e.stopPropagation();
          slot.items.splice(idx,1);
          renderAgendaPanel(); saveState();
        });

        // Drag reorder within slot
        itemRow.addEventListener('dragstart', ()=> itemRow.classList.add('dragging'));
        itemRow.addEventListener('dragover', (e)=>{
          e.preventDefault();
          const dragging = itemsWrap.querySelector('.slot-item.dragging');
          if (!dragging) return;
          const after = getSlotItemAfter(itemsWrap, e.clientY);
          if (after==null) itemsWrap.appendChild(dragging);
          else itemsWrap.insertBefore(dragging, after);
        });
        itemRow.addEventListener('dragend', ()=>{
          itemRow.classList.remove('dragging');
          const nodes=[...itemsWrap.querySelectorAll('.slot-item')];
          const newOrder = nodes.map(n=>{
            const i = parseInt(n.dataset.index,10);
            return slot.items[i];
          }).filter(Boolean);
          if (newOrder.length === (slot.items||[]).length){
            slot.items = newOrder;
            renderAgendaPanel(); saveState();
          }
        });

        itemRow.appendChild(nameSpan);
        itemRow.appendChild(typeSpan);
        itemRow.appendChild(btnX);
        itemsWrap.appendChild(itemRow);
      });

      card.appendChild(itemsWrap);
      
      // FEATURE: Quick action buttons container
      const quickActionsDiv = document.createElement('div');
      quickActionsDiv.className = 'quick-actions-container';
      quickActionsDiv.innerHTML = `
        <button class="add-custom-btn" title="Add Custom Media">
          <svg viewBox="0 0 24 24" width="16" height="16">
            <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
          </svg>
        </button>
        <div class="custom-media-menu" style="display:none">
          <button data-type="text">Free Text</button>
          <button data-type="link">Link/URL</button>
          <button data-type="photo">Photo</button>
        </div>
        
        <button class="quick-assign-btn" title="Quick Assign Media">
          <svg viewBox="0 0 24 24" width="16" height="16">
            <path fill="currentColor" d="M7 10l5 5 5-5z"/>
          </svg>
        </button>
        <div class="quick-assign-menu" style="display:none">
          <div class="quick-assign-section">
            <div class="quick-assign-label">Videos</div>
            <div class="quick-assign-items" data-type="video"></div>
          </div>
          <div class="quick-assign-section">
            <div class="quick-assign-label">Presentations</div>
            <div class="quick-assign-items" data-type="pdf"></div>
          </div>
        </div>
      `;
      
      const addBtn = quickActionsDiv.querySelector('.add-custom-btn');
      const customMenu = quickActionsDiv.querySelector('.custom-media-menu');
      const assignBtn = quickActionsDiv.querySelector('.quick-assign-btn');
      const assignMenu = quickActionsDiv.querySelector('.quick-assign-menu');
      
      // Custom media menu handler
      addBtn.addEventListener('click', (e)=>{
        e.stopPropagation();
        assignMenu.style.display = 'none'; // Close other menu
        customMenu.style.display = customMenu.style.display === 'none' ? 'flex' : 'none';
      });
      
      quickActionsDiv.querySelectorAll('.custom-media-menu button').forEach(btn => {
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const type = btn.dataset.type;
          customMenu.style.display = 'none';
          showCustomMediaForm(card, slot, type);
        });
      });
      
      // Quick assign menu handler
      assignBtn.addEventListener('click', (e)=>{
        e.stopPropagation();
        customMenu.style.display = 'none'; // Close other menu
        
        // Populate menus with current media
        const videoContainer = assignMenu.querySelector('[data-type="video"]');
        const pdfContainer = assignMenu.querySelector('[data-type="pdf"]');
        
        videoContainer.innerHTML = '';
        pdfContainer.innerHTML = '';
        
        // Add videos
        videoFiles.forEach(v => {
          const btn = document.createElement('button');
          btn.className = 'quick-assign-item';
          btn.textContent = displayName(v);
          btn.addEventListener('click', (e)=>{
            e.stopPropagation();
            if (!slot.items) slot.items = [];
            const exists = slot.items.some(it=> it.id===v._id && it.type==='video');
            if (!exists) {
              slot.items.push({id:v._id, type:'video'});
              renderAgendaPanel(); saveState();
            }
            assignMenu.style.display = 'none';
          });
          videoContainer.appendChild(btn);
        });
        
        if (videoFiles.length === 0) {
          videoContainer.innerHTML = '<div class="quick-assign-empty">No videos</div>';
        }
        
        // Add presentations
        presentationFiles.forEach(p => {
          const btn = document.createElement('button');
          btn.className = 'quick-assign-item';
          btn.textContent = displayName(p);
          btn.addEventListener('click', (e)=>{
            e.stopPropagation();
            if (!slot.items) slot.items = [];
            const exists = slot.items.some(it=> it.id===p._id && it.type==='pdf');
            if (!exists) {
              slot.items.push({id:p._id, type:'pdf'});
              renderAgendaPanel(); saveState();
            }
            assignMenu.style.display = 'none';
          });
          pdfContainer.appendChild(btn);
        });
        
        if (presentationFiles.length === 0) {
          pdfContainer.innerHTML = '<div class="quick-assign-empty">No presentations</div>';
        }
        
        assignMenu.style.display = assignMenu.style.display === 'none' ? 'block' : 'none';
      });
      
      card.appendChild(quickActionsDiv);
      agendaPanel.appendChild(card);
    });
    
    // Add overall vertical progress bar
    addOverallProgressBar();
    
    // Apply locked state if enabled
    const isLocked = localStorage.getItem('agenda_locked') === 'true';
    if (isLocked) {
      agendaPanel.classList.add('locked');
    }
    
    // Set up global click handler for closing menus (only once, outside the loop)
    setupQuickActionsClickHandler();
  }
  
  // Global click handler for quick actions menus (prevents duplicate listeners)
  let quickActionsClickHandlerSetup = false;
  function setupQuickActionsClickHandler(){
    if (quickActionsClickHandlerSetup) return;
    quickActionsClickHandlerSetup = true;
    
    // Use mousedown instead of click to avoid conflicts with button handlers
    document.addEventListener('mousedown', (e)=>{
      // Check if click is outside all quick actions containers
      const clickedInContainer = e.target.closest('.quick-actions-container');
      if (!clickedInContainer) {
        document.querySelectorAll('.custom-media-menu, .quick-assign-menu').forEach(menu => {
          menu.style.display = 'none';
        });
      }
    });
  }
  
  function getSlotItemAfter(container, y){
    const draggable=[...container.querySelectorAll('.slot-item:not(.dragging)')];
    return draggable.reduce((closest,child)=>{
      const box=child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if (offset<0 && offset>closest.offset) return {offset,element:child};
      return closest;
    },{offset:Number.NEGATIVE_INFINITY}).element;
  }

  // Clock (uses selected TZ)
  function updateTZClock(){
    const p = tzNowHM(timeZone);
    if (gmtClockValue) gmtClockValue.textContent = `${String(p.h).padStart(2,'0')}:${String(p.m).padStart(2,'0')}:${String(p.s).padStart(2,'0')}`;
    if (tzLabel) tzLabel.textContent = `Current time (${zoneShortLabel(timeZone)})`;
    if (appMode==='meeting') updateAgendaDynamicParts();
  }
  
  // Update only dynamic parts of agenda (NOW badges and progress bars) without re-rendering
  function updateAgendaDynamicParts(){
    // Safety check: if any menus are open, skip the update to avoid interfering
    const anyMenuOpen = document.querySelector('.custom-media-menu[style*="flex"], .quick-assign-menu[style*="block"]');
    if (anyMenuOpen) return;
    
    const nowMins = getNowTZMinutes();
    const slots = agendaPanel.querySelectorAll('.agenda-slot');
    
    slots.forEach((card, idx) => {
      const slot = agendaSlots[idx];
      if (!slot) return;
      
      const sStart = parseHHMM(slot.start);
      const sEnd = parseHHMM(slot.end);
      const active = (sStart!=null && sEnd!=null && nowMins>=sStart && nowMins<=sEnd);
      
      // Update active class
      if (active) {
        card.classList.add('active');
      } else {
        card.classList.remove('active');
      }
      
      // Update NOW badge
      const header = card.querySelector('.slot-header');
      if (header) {
        const existingBadge = header.querySelector('.slot-badge');
        if (active && !existingBadge) {
          // Add NOW badge
          const right = Array.from(header.children).find(el => el.style.display === 'flex' && el.style.alignItems === 'center');
          if (right) {
            const badge = document.createElement('span');
            badge.className = 'slot-badge';
            badge.textContent = 'NOW';
            right.insertBefore(badge, right.firstChild);
          }
        } else if (!active && existingBadge) {
          // Remove NOW badge
          existingBadge.remove();
        }
      }
      
      // Individual progress bars removed - using overall progress bar instead
    });
    
    // Update overall progress bar
    updateOverallProgressBar();
  }
  let clockTimer = null;
  function startClock(){ if (clockTimer) clearInterval(clockTimer); clockTimer = setInterval(updateTZClock, 1000); updateTZClock(); }

  // Add overall vertical progress bar to agenda panel
  function addOverallProgressBar(){
    // Remove existing progress bar if any
    const existing = agendaPanel.querySelector('.agenda-overall-progress');
    if (existing) existing.remove();
    
    if (agendaSlots.length === 0) return;
    
    const progressBar = document.createElement('div');
    progressBar.className = 'agenda-overall-progress';
    
    const progressFill = document.createElement('div');
    progressFill.className = 'progress-fill';
    
    const progressIndicator = document.createElement('div');
    progressIndicator.className = 'progress-indicator';
    
    progressBar.appendChild(progressFill);
    progressBar.appendChild(progressIndicator);
    agendaPanel.appendChild(progressBar);
    
    // Initial update
    updateOverallProgressBar();
  }
  
  // Update overall progress bar position
  function updateOverallProgressBar(){
    const progressBar = agendaPanel.querySelector('.agenda-overall-progress');
    if (!progressBar || agendaSlots.length === 0) return;
    
    const progressFill = progressBar.querySelector('.progress-fill');
    const progressIndicator = progressBar.querySelector('.progress-indicator');
    if (!progressFill || !progressIndicator) return;
    
    // Find first and last slot times
    const firstStart = parseHHMM(agendaSlots[0].start);
    const lastEnd = parseHHMM(agendaSlots[agendaSlots.length - 1].end);
    
    if (firstStart == null || lastEnd == null || lastEnd <= firstStart) {
      progressFill.style.height = '0%';
      progressIndicator.style.top = '0%';
      return;
    }
    
    const nowMins = getNowTZMinutes();
    let pct = clamp(((nowMins - firstStart) / (lastEnd - firstStart)) * 100, 0, 100);
    
    progressFill.style.height = pct.toFixed(1) + '%';
    progressIndicator.style.top = pct.toFixed(1) + '%';
  }
  
  // Toggle agenda lock state
  function toggleAgendaLock(){
    const isLocked = agendaPanel.classList.toggle('locked');
    localStorage.setItem('agenda_locked', isLocked ? 'true' : 'false');
    
    // Update button icon and title
    const lockBtn = document.getElementById('lockAgendaBtn');
    if (lockBtn) {
      const icon = lockBtn.querySelector('use');
      if (icon) {
        icon.setAttribute('href', isLocked ? '#lock' : '#unlock');
      }
      lockBtn.title = isLocked ? 'Unlock Agenda' : 'Lock Agenda';
    }
  }

  // Events
  settingsBtn.addEventListener('click', showSettings);
  modalClose.addEventListener('click', ()=> { modalOverlay.classList.remove('show'); markOnboarded(); });
  modalOverlay.addEventListener('click', (e)=>{ if (e.target===modalOverlay) { modalOverlay.classList.remove('show'); markOnboarded(); } });

  // Mode radios
  if (modePresentation) modePresentation.addEventListener('change', ()=> setAppMode('presentation'));
  if (modeMeeting) modeMeeting.addEventListener('change', ()=> setAppMode('meeting'));

  // Time zone change
  if (timeZoneSelect){
    timeZoneSelect.addEventListener('change', (e)=>{
      timeZone = e.target.value || 'Europe/Paris';
      saveState();
      updateTZClock();
      renderAgendaPanel();
    });
  }

  // Agenda quick add buttons
  addSlot15Btn.addEventListener('click', ()=> addAgendaSlotWithDuration(15));
  addSlot30Btn.addEventListener('click', ()=> addAgendaSlotWithDuration(30));
  addSlot60Btn.addEventListener('click', ()=> addAgendaSlotWithDuration(60));

  // Sort events (modal only)
  if (videoSortSelectModal) videoSortSelectModal.addEventListener('change', e=> { sortModeVideos = e.target.value; applySortVideos(); renderVideoList(); renderModalVideoList(); saveState(); });
  if (presSortSelectModal) presSortSelectModal.addEventListener('change', e=> { sortModePresentations = e.target.value; applySortPresentations(); renderPresentationList(); renderModalPresentationList(); saveState(); });

  // Fullscreen events
  if (fullscreenBtns.length){
    fullscreenBtns.forEach(btn=> btn.addEventListener('click', toggleFullscreen));
    document.addEventListener('keydown', (e)=>{ if (e.key==='f' || e.key==='F') toggleFullscreen(); });
    ['fullscreenchange','webkitfullscreenchange','msfullscreenchange'].forEach(ev => document.addEventListener(ev, updateFullscreenUI));
  }

  // Settings: Loop on/off
  function toggleLoop(){
    loopMode = !loopMode;
    updateLoopUI();
    saveState();
  }
  loopToggle.addEventListener('click', toggleLoop);
  loopToggle.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') { e.preventDefault(); toggleLoop(); } });

  // Loop mode type toggle (header button)
  loopModeBtn.addEventListener('click', toggleLoopModeType);

  // Add buttons
  videoAddBtn.addEventListener('click', ()=> videoInputAdd.click());
  presentationAddBtn.addEventListener('click', ()=> presentationInputAdd.click());
  videoInputAdd.addEventListener('change', e=>{ handleVideoAdd(e.target.files); e.target.value=''; });
  presentationInputAdd.addEventListener('change', e=>{ handlePresentationAdd(e.target.files); e.target.value=''; });

  // NEW: Clear All Videos button
  if (videoClearBtn) {
    videoClearBtn.addEventListener('click', ()=> {
      if (videoFiles.length === 0) {
        showToast('No videos to clear');
        return;
      }
      if (confirm(`Are you sure you want to remove all ${videoFiles.length} video(s)?`)) {
        // Stop and clear current video if playing
        if (activeView==='video') {
          stopVideo();
          if (currentVideoUrl) try{ URL.revokeObjectURL(currentVideoUrl); }catch(_){}
          videoPlayer.removeAttribute('src');
          videoContainer.style.display='none';
          emptyState.style.display='flex';
          activeView=null;
        }
        videoFiles = [];
        currentVideoIndex = -1;
        renderVideoList();
        renderModalVideoList();
        populateCompactSelects();
        updateNavBackBtn();
        saveState();
        showToast('All videos cleared');
      }
    });
  }

  // NEW: Build Agenda button
  if (buildAgendaBtn) {
    buildAgendaBtn.addEventListener('click', ()=> {
      showSettings();
      // Switch to General tab where agenda is
      document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelector('[data-tab="general"]')?.classList.add('active');
      document.getElementById('generalTab')?.classList.add('active');
    });
  }

  // NEW: Settings tabs
  document.querySelectorAll('.settings-tab').forEach(tab => {
    tab.addEventListener('click', ()=> {
      const tabName = tab.dataset.tab;
      document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tabName+'Tab')?.classList.add('active');
    });
  });

  // NEW: Multi-select event handlers
  if (slotAssignDropdown) {
    slotAssignDropdown.addEventListener('change', (e)=> {
      const slotId = e.target.value;
      if (slotId && multiSelectedItems.size > 0) {
        assignSelectedToSlot(slotId);
        e.target.value = ''; // Reset dropdown
      }
    });
  }

  if (clearSelectionBtn) {
    clearSelectionBtn.addEventListener('click', ()=> {
      multiSelectedItems.clear();
      renderVideoList();
      renderPresentationList();
      updateMultiSelectUI();
    });
  }

  // Compact selects
  videoSelectCompact.addEventListener('change', e=>{ const idx=parseInt(e.target.value,10); if(!isNaN(idx)&&idx>=0) playVideo(idx); });
  presentationSelectCompact.addEventListener('change', e=>{ const idx=parseInt(e.target.value,10); if(!isNaN(idx)&&idx>=0) loadPresentation(idx); });
  
  // NEW: Combined dropdown handler for top/bottom menu
  if (combinedMediaSelect) {
    combinedMediaSelect.addEventListener('change', e=>{
      const val = e.target.value;
      if (!val) return;
      const [type, idxStr] = val.split(':');
      const idx = parseInt(idxStr,10);
      if (isNaN(idx) || idx<0) return;
      if (type==='video') playVideo(idx);
      else if (type==='pdf') loadPresentation(idx);
    });
  }

  // Video ended behavior
  videoPlayer.addEventListener('ended', ()=>{
    if (!loopMode) return;
    if (loopModeType === 'single'){
      if (!videoPlayer.loop) { videoPlayer.play().catch(()=>{}); }
    } else if (loopModeType === 'playlist'){
      playNextInPlaylist();
    }
  });

  // PDF controls
  prevPageBtn.addEventListener('click', ()=>{ if (pdfDoc && currentPage>1){ currentPage--; renderPdfPage(currentPage); const meta=presentationFiles[presentationIndex]; if(meta) meta._currentPage=currentPage; saveState(); }});
  nextPageBtn.addEventListener('click', ()=>{ if (pdfDoc && currentPage<pdfDoc.numPages){ currentPage++; renderPdfPage(currentPage); const meta=presentationFiles[presentationIndex]; if(meta) meta._currentPage=currentPage; saveState(); }});

  // NEW FEATURE: PDF Click Navigation - click anywhere on canvas to advance
  if (pdfCanvas){
    pdfCanvas.addEventListener('click', ()=>{
      if (pdfDoc && currentPage < pdfDoc.numPages){
        currentPage++;
        renderPdfPage(currentPage);
        const meta = presentationFiles[presentationIndex];
        if (meta) meta._currentPage = currentPage;
        saveState();
      }
    });
  }

  // NEW FEATURE: PDF Keyboard Shortcuts
  document.addEventListener('keydown', (e)=>{
    // Only handle keys when PDF is active
    if (activeView !== 'presentation' || !pdfDoc) return;
    
    let handled = false;
    
    if (e.key === 'ArrowRight' || e.key === ' ' || e.key === 'PageDown'){
      // Next page
      if (currentPage < pdfDoc.numPages){
        currentPage++;
        renderPdfPage(currentPage);
        const meta = presentationFiles[presentationIndex];
        if (meta) meta._currentPage = currentPage;
        saveState();
      }
      handled = true;
    } else if (e.key === 'ArrowLeft' || e.key === 'Backspace' || e.key === 'PageUp'){
      // Previous page
      if (currentPage > 1){
        currentPage--;
        renderPdfPage(currentPage);
        const meta = presentationFiles[presentationIndex];
        if (meta) meta._currentPage = currentPage;
        saveState();
      }
      handled = true;
    } else if (e.key === 'Home'){
      // First page
      currentPage = 1;
      renderPdfPage(currentPage);
      const meta = presentationFiles[presentationIndex];
      if (meta) meta._currentPage = currentPage;
      saveState();
      handled = true;
    } else if (e.key === 'End'){
      // Last page
      currentPage = pdfDoc.numPages;
      renderPdfPage(currentPage);
      const meta = presentationFiles[presentationIndex];
      if (meta) meta._currentPage = currentPage;
      saveState();
      handled = true;
    }
    
    if (handled){
      e.preventDefault();
    }
  });

  // NEW FEATURE: Full-screen Agenda Display event listeners
  if (showFullAgendaBtn){
    showFullAgendaBtn.addEventListener('click', showFullAgenda);
  }
  if (agendaDisplayClose){
    agendaDisplayClose.addEventListener('click', hideFullAgenda);
  }
  if (agendaDisplayOverlay){
    agendaDisplayOverlay.addEventListener('click', (e)=>{
      if (e.target === agendaDisplayOverlay) hideFullAgenda();
    });
  }
  
  // Lock/Unlock agenda button
  const lockAgendaBtn = document.getElementById('lockAgendaBtn');
  if (lockAgendaBtn){
    lockAgendaBtn.addEventListener('click', toggleAgendaLock);
    // Initialize lock state on page load
    const isLocked = localStorage.getItem('agenda_locked') === 'true';
    if (isLocked) {
      const icon = lockAgendaBtn.querySelector('use');
      if (icon) icon.setAttribute('href', '#lock');
      lockAgendaBtn.title = 'Unlock Agenda';
    }
  }
  // ESC key to close full-screen agenda
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape' && agendaDisplayOverlay && agendaDisplayOverlay.classList.contains('show')){
      hideFullAgenda();
    }
  });

  // NEW: Unified back navigation button
  navBackBtn.addEventListener('click', ()=>{
    if (activeView === 'video' && presentationFiles.length > 0) {
      // From video to last viewed presentation
      const idx = Math.max(0, presentationIndex);
      loadPresentation(idx);
    } else if (activeView === 'presentation' && videoFiles.length > 0) {
      // From presentation to last played video (or first)
      if (presentationIndex>=0 && pdfDoc){
        const pres=presentationFiles[presentationIndex]; if(pres) pres._currentPage=currentPage;
      }
      presentationContainer.style.display='none';
      activeView='video';
      videoContainer.style.display='flex';
      emptyState.style.display='none';
      stopVideo();
      updateNavBackBtn();
    }
  });

  // Update navBackBtn visibility based on available media
  function updateNavBackBtn() {
    const shouldShow = (activeView === 'video' && presentationFiles.length > 0) || 
                       (activeView === 'presentation' && videoFiles.length > 0);
    if (shouldShow) {
      navBackBtn.classList.add('show');
      navBackBtn.title = activeView === 'video' ? 'Switch to Presentation' : 'Switch to Video';
    } else {
      navBackBtn.classList.remove('show');
    }
  }

  // Position buttons
  document.querySelectorAll('.position-btn').forEach(btn=> {
    // store original title for later
    btn.setAttribute('data-title', btn.title || '');
    btn.addEventListener('click', ()=> setMenuPosition(btn.dataset.position));
  });

  // Resize handle
  resizeHandle.addEventListener('mousedown', e=>{
    e.preventDefault(); resizing=true; resizeHandle.classList.add('active');
    start = (menuPos==='left'||menuPos==='right') ? e.clientX : e.clientY;
    orig  = (menuPos==='left'||menuPos==='right') ? menuPanel.offsetWidth : menuPanel.offsetHeight;
    document.body.style.cursor = (menuPos==='left'||menuPos==='right') ? 'ew-resize' : 'ns-resize';
    window.addEventListener('mousemove', doResize);
    window.addEventListener('mouseup', stopResize);
  });
  function doResize(e){
    if (!resizing) return; let delta,newSize;
    if (menuPos==='left'){ delta=e.clientX-start; newSize=clamp(orig+delta,240,720); menuPanel.style.width=newSize+'px'; mainContent.style.left=newSize+'px'; mainContent.style.width=`calc(100vw - ${newSize}px)`; }
    else if (menuPos==='right'){ delta=start-e.clientX; newSize=clamp(orig+delta,240,720); menuPanel.style.width=newSize+'px'; mainContent.style.right=newSize+'px'; mainContent.style.width=`calc(100vw - ${newSize}px)`; }
    else if (menuPos==='top'){ delta=e.clientY-start; const minH=Math.floor(innerHeight*0.10), maxH=Math.floor(innerHeight*0.35); newSize=clamp(orig+delta,minH,maxH); menuPanel.style.height=newSize+'px'; mainContent.style.top=newSize+'px'; mainContent.style.height=`calc(100vh - ${newSize}px)`; }
    else { delta=start-e.clientY; const minH=Math.floor(innerHeight*0.10), maxH=Math.floor(innerHeight*0.35); newSize=clamp(orig+delta,minH,maxH); menuPanel.style.height=newSize+'px'; mainContent.style.bottom=newSize+'px'; mainContent.style.height=`calc(100vh - ${newSize}px)`; }
    applyMenuFontScale();
    if (pdfDoc && activeView==='presentation') renderPdfPage(currentPage);
  }
  function stopResize(){ resizing=false; resizeHandle.classList.remove('active'); document.body.style.cursor=''; window.removeEventListener('mousemove', doResize); window.removeEventListener('mouseup', stopResize); saveState(); }

  // Window resize
  window.addEventListener('resize', ()=>{ setMenuPosition(menuPos); applyMenuFontScale(); if (pdfDoc && activeView==='presentation') renderPdfPage(currentPage); });

  // FEATURE 2: Search functionality
  function filterVideos(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    const items = videoList.querySelectorAll('.file-item');
    items.forEach(item => {
      const name = item.querySelector('.file-item-name')?.textContent.toLowerCase() || '';
      if (!term || name.includes(term)) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });
  }

  function filterPresentations(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    const items = presentationList.querySelectorAll('.file-item');
    items.forEach(item => {
      const name = item.querySelector('.file-item-name')?.textContent.toLowerCase() || '';
      if (!term || name.includes(term)) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });
  }

  if (videoSearchInput) {
    videoSearchInput.addEventListener('input', (e) => filterVideos(e.target.value));
  }

  if (presentationSearchInput) {
    presentationSearchInput.addEventListener('input', (e) => filterPresentations(e.target.value));
  }

  // FEATURE 6: Menu toggle functionality
  function toggleMenu() {
    menuVisible = !menuVisible;
    if (menuVisible) {
      menuPanel.classList.remove('hidden');
      mainContent.classList.remove('menu-hidden');
      menuToggleBtn.classList.remove('hidden-position');
      // Show green background when menu visible
      document.documentElement.classList.add('menu-visible');
      document.body.classList.add('menu-visible');
    } else {
      menuPanel.classList.add('hidden');
      mainContent.classList.add('menu-hidden');
      menuToggleBtn.classList.add('hidden-position');
      // Remove green background when menu hidden (black background for full-screen media)
      document.documentElement.classList.remove('menu-visible');
      document.body.classList.remove('menu-visible');
    }
    
    // Force re-render of media to adjust to new viewport size
    // Wait for CSS transitions and layout changes to complete
    setTimeout(() => {
      // For videos: force size recalculation by triggering a resize event
      if (activeView === 'video' && videoPlayer && !videoPlayer.paused) {
        // Trigger video element to recalculate its displayed size
        const currentTime = videoPlayer.currentTime;
        videoPlayer.style.width = '100%';
        videoPlayer.style.height = '100%';
      }
      
      // For PDFs: re-render at new size
      if (pdfDoc && activeView === 'presentation') {
        renderPdfPage(currentPage);
      }
      
      // Dispatch window resize event to trigger any other responsive adjustments
      window.dispatchEvent(new Event('resize'));
    }, 350);
  }

  if (menuToggleBtn) {
    menuToggleBtn.addEventListener('click', toggleMenu);
    // Initialize button position - use classList to preserve other classes
    menuToggleBtn.classList.add(menuPos);
  }

  // Init
  (function init(){
    tryAttachQuartzSprite();

    // Initialize menu-visible class (menu starts visible)
    document.documentElement.classList.add('menu-visible');
    document.body.classList.add('menu-visible');

    const s = loadState();
    if (s){
      menuPos = s.menuPos || 'left';
      appMode = s.appMode || 'presentation';
      loopMode = !!s.loopMode;
      loopModeType = s.loopModeType || 'single';
      agendaSlots = Array.isArray(s.agendaSlots) ? s.agendaSlots : [];
      if (s.sortModeVideos) sortModeVideos = s.sortModeVideos;
      if (s.sortModePresentations) sortModePresentations = s.sortModePresentations;
      if (s.timeZone) timeZone = s.timeZone; // load TZ
    } else {
      // default to CET
      timeZone = 'Europe/Paris';
    }
    if (timeZoneSelect) timeZoneSelect.value = timeZone;

    if (appMode==='meeting' && menuPos!=='left'){ menuPos='left'; }
    setMenuPosition(menuPos);
    applyMenuFontScale();

    updateLoopModeBtn();
    updateLoopUI();

    applySortVideos();
    applySortPresentations();

    renderVideoList();
    renderPresentationList();

    refreshModeControls();
    renderAgendaRows();
    renderAgendaPanel();
    startClock(); // uses TZ

    updateFullscreenUI();

    const onboarded = (localStorage.getItem(ONBOARDED_KEY) === '1');
    if (!onboarded){
      setTimeout(()=>{
        showSettings();
        // Switch to Media Library tab on first launch
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelector('[data-tab="media"]')?.classList.add('active');
        document.getElementById('mediaTab')?.classList.add('active');
      }, 0);
    }
  })();


  
  // FEATURE: Show form to add custom media
  function showCustomMediaForm(card, slot, type){
    const existing = card.querySelector('.custom-media-form');
    if (existing) existing.remove();
    
    const form = document.createElement('div');
    form.className = 'custom-media-form';
    
    if (type === 'text'){
      form.innerHTML = `
        <textarea placeholder="Enter text content..." class="text-input"></textarea>
        <div class="custom-media-form-actions">
          <button class="add-btn">Add Text</button>
          <button class="cancel-btn">Cancel</button>
        </div>
      `;
      form.querySelector('.add-btn').addEventListener('click', ()=>{
        const content = form.querySelector('.text-input').value.trim();
        if (!content) return alert('Please enter some text');
        if (!slot.items) slot.items = [];
        slot.items.push({id:makeId(), type:'text', data:{content}});
        form.remove();
        renderAgendaPanel(); saveState();
      });
    } else if (type === 'link'){
      form.innerHTML = `
        <input type="text" placeholder="Link name..." class="name-input" />
        <input type="url" placeholder="https://..." class="url-input" />
        <div class="custom-media-form-actions">
          <button class="add-btn">Add Link</button>
          <button class="cancel-btn">Cancel</button>
        </div>
      `;
      form.querySelector('.add-btn').addEventListener('click', ()=>{
        const name = form.querySelector('.name-input').value.trim();
        const url = form.querySelector('.url-input').value.trim();
        if (!name || !url) return alert('Please enter both name and URL');
        if (!slot.items) slot.items = [];
        slot.items.push({id:makeId(), type:'link', data:{name, url}});
        form.remove();
        renderAgendaPanel(); saveState();
      });
    } else if (type === 'photo'){
      form.innerHTML = `
        <input type="file" accept="image/*" class="photo-input" />
        <div class="custom-media-form-actions">
          <button class="add-btn">Add Photo</button>
          <button class="cancel-btn">Cancel</button>
        </div>
      `;
      form.querySelector('.add-btn').addEventListener('click', ()=>{
        const fileInput = form.querySelector('.photo-input');
        const file = fileInput.files[0];
        if (!file) return alert('Please select a photo');
        if (!slot.items) slot.items = [];
        const url = URL.createObjectURL(file);
        slot.items.push({id:makeId(), type:'photo', data:{name:file.name, file, url}});
        form.remove();
        // Don't call renderAgendaPanel() to avoid re-creating everything
        // Instead, manually add the item to the DOM
        const itemsWrap = card.querySelector('.slot-items');
        if (itemsWrap) {
          const itemRow = document.createElement('div');
          itemRow.className = 'slot-item';
          
          const nameSpan = document.createElement('span');
          nameSpan.className = 'si-name';
          nameSpan.textContent = file.name;
          
          const typeSpan = document.createElement('span');
          typeSpan.className = 'si-type';
          typeSpan.textContent = 'PHOTO';
          typeSpan.style.background = '#a855f7';
          
          const btnX = document.createElement('button');
          btnX.className = 'si-x';
          btnX.title = 'Remove';
          btnX.textContent = '×';
          btnX.addEventListener('click', (e)=>{
            e.stopPropagation();
            const idx = slot.items.findIndex(it => it.type==='photo' && it.data.name===file.name);
            if (idx >= 0) {
              slot.items.splice(idx, 1);
              itemRow.remove();
              saveState();
            }
          });
          
          itemRow.appendChild(nameSpan);
          itemRow.appendChild(typeSpan);
          itemRow.appendChild(btnX);
          itemRow.addEventListener('click', ()=> {
            if (url) window.open(url, '_blank');
          });
          
          itemsWrap.appendChild(itemRow);
        }
        saveState();
      });
    }
    
    form.querySelector('.cancel-btn').addEventListener('click', ()=> form.remove());
    card.appendChild(form);
  }


  
  // FEATURE: Floating assign toolbar positioning and logic
  const floatingToolbar = document.getElementById('floatingAssignToolbar');
  const floatingToolbarLabel = document.getElementById('floatingToolbarLabel');
  const floatingSlotDropdown = document.getElementById('floatingSlotDropdown');
  const floatingAssignBtn = document.getElementById('floatingAssignBtn');
  const floatingClearBtn = document.getElementById('floatingClearBtn');
  
  function updateFloatingToolbarPosition(){
    if (menuPos === 'left'){
      floatingToolbar.style.left = '370px';
      floatingToolbar.style.top = '80px';
      floatingToolbar.style.right = 'auto';
      floatingToolbar.style.bottom = 'auto';
    } else if (menuPos === 'right'){
      floatingToolbar.style.right = '370px';
      floatingToolbar.style.top = '80px';
      floatingToolbar.style.left = 'auto';
      floatingToolbar.style.bottom = 'auto';
    } else if (menuPos === 'top'){
      floatingToolbar.style.left = '20px';
      floatingToolbar.style.top = '130px';
      floatingToolbar.style.right = 'auto';
      floatingToolbar.style.bottom = 'auto';
    } else {
      floatingToolbar.style.left = '20px';
      floatingToolbar.style.bottom = '130px';
      floatingToolbar.style.top = 'auto';
      floatingToolbar.style.right = 'auto';
    }
  }
  
  function updateFloatingToolbar(){
    const count = multiSelectedItems.size;
    if (count > 0 && appMode === 'meeting'){
      floatingToolbarLabel.textContent = count + ' selected';
      populateFloatingSlotDropdown();
      floatingToolbar.classList.add('show');
      updateFloatingToolbarPosition();
    } else {
      floatingToolbar.classList.remove('show');
    }
  }
  
  function populateFloatingSlotDropdown(){
    floatingSlotDropdown.innerHTML = '<option value="">Select slot...</option>';
    agendaSlots.forEach((s,i)=>{
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = (s.title||'Untitled') + ' (' + (s.start||'') + ' - ' + (s.end||'') + ')';
      floatingSlotDropdown.appendChild(opt);
    });
  }
  
  function assignSelectedToFloatingSlot(){
    const slotIdx = parseInt(floatingSlotDropdown.value, 10);
    if (isNaN(slotIdx) || slotIdx < 0 || slotIdx >= agendaSlots.length) return alert('Please select a slot');
    const slot = agendaSlots[slotIdx];
    if (!slot.items) slot.items = [];
    
    multiSelectedItems.forEach(key=>{
      const [type, id] = key.split(':');
      const exists = slot.items.some(it=> it.id===id && it.type===type);
      if (!exists) slot.items.push({id, type});
    });
    
    multiSelectedItems.clear();
    renderVideoList(); renderPresentationList(); renderAgendaPanel(); saveState();
    updateFloatingToolbar();
  }
  
  function clearFloatingSelection(){
    multiSelectedItems.clear();
    renderVideoList(); renderPresentationList();
    updateFloatingToolbar();
  }
  
  floatingAssignBtn.addEventListener('click', assignSelectedToFloatingSlot);
  floatingClearBtn.addEventListener('click', clearFloatingSelection);

  // Expose for debug
  window.__SMO = { setLoopModeType, toggleLoopModeType, setAppMode };

})();
</script>
</body>

